name: All-in-One Workflow Fixer

on:
  workflow_dispatch:
    inputs:
      fix-type:
        description: 'Type of fix to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - permissions
          - security
          - deployment
          - dependencies
          - performance
          - documentation
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - '.github/actions-config/**'
  schedule:
    - cron: '0 12 * * *'  # 每天中午12点运行

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: write
  deployments: write
  issues: write
  packages: write
  repository-projects: write
  security-events: write
  statuses: write
  workflows: write

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq pyyaml requests
          npm install -g yaml-lint

      - name: Validate actions-config directory
        run: |
          if [ ! -d ".github/actions-config" ]; then
            echo "Creating actions-config directory..."
            mkdir -p .github/actions-config
          fi
          
          if [ ! -f ".github/actions-config/actions.yaml" ]; then
            echo "Creating actions.yaml file..."
            cat > .github/actions-config/actions.yaml << EOF
allowed_sources:
  - actions/checkout
  - actions/setup-node
  - actions/setup-python
  - actions/cache
  - actions/upload-artifact
  - actions/download-artifact
  - github/codeql-action
  - actions/dependency-review-action
  - reviewdog/reviewdog
  - codecov/codecov-action
  - 8398a7/action-slack
  - actions/github-script

installed_actions:
  - name: actions/checkout
    version: v4
    source: actions/checkout
    usage: 每天使用
    security: 已审核
    workflows: []

custom_actions:
  directory: ".github/actions"
  list: []
EOF
          fi

      - name: Fix workflow syntax errors
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'syntax'
        uses: reviewdog/reviewdog@v0.16.0
        with:
          reporter: github-pr-review
          level: error
          workdir: .github/workflows/

      - name: Fix expression syntax (steps.analyze.outputs.errors issue)
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if grep -q 'if: steps\.' "$file"; then
              echo "Fixing expression syntax in $file..."
              sed -i 's/if: steps\./if: ${{ steps\./g' "$file"
              sed -i 's/!= ''/ != '' }}/g' "$file"
            fi
          done

      - name: Fix permission issues
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'permissions'
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Checking permissions in $file..."
            # 检查是否存在空权限部分
            if grep -q 'permissions: {}' "$file"; then
              echo "Fixing empty permissions in $file..."
              sed -i 's/permissions: {}/permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read\n  workflows: read/g' "$file"
            fi
            # 检查是否缺少必要的权限
            if ! grep -q 'permissions:' "$file"; then
              echo "Adding basic permissions to $file..."
              # 在jobs部分之前添加权限
              sed -i '/jobs:/i \permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read\n  workflows: read\n' "$file"
            fi
          done

      - name: Run security scan
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security'
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, go

      - name: Analyze code
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security'
        uses: github/codeql-action/analyze@v3

      - name: Dependency review
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'dependencies'
        uses: actions/dependency-review-action@v4

      - name: Update Action versions
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'dependencies'
        run: |
          # 更新常见Action版本
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Updating Action versions in $file..."
            # 更新actions/checkout
            sed -i 's/actions\/checkout@v[0-9]\+/actions\/checkout@v4/g' "$file"
            # 更新actions/setup-node
            sed -i 's/actions\/setup-node@v[0-9]\+/actions\/setup-node@v5/g' "$file"
            # 更新actions/setup-python
            sed -i 's/actions\/setup-python@v[0-9]\+/actions\/setup-python@v5/g' "$file"
            # 更新actions/cache
            sed -i 's/actions\/cache@v[0-9]\+/actions\/cache@v4/g' "$file"
            # 更新actions/upload-artifact
            sed -i 's/actions\/upload-artifact@v[0-9]\+/actions\/upload-artifact@v4/g' "$file"
            # 更新actions/download-artifact
            sed -i 's/actions\/download-artifact@v[0-9]\+/actions\/download-artifact@v4/g' "$file"
          done

      - name: Optimize workflow performance
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'performance'
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Optimizing performance in $file..."
            # 添加缓存配置
            if ! grep -q 'actions/cache' "$file"; then
              # 在setup-node之后添加缓存
              if grep -q 'actions/setup-node' "$file"; then
                sed -i '/actions\/setup-node@v5/a \      - name: Cache npm dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.npm\n          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}\n          restore-keys: |\n            ${{ runner.os }}-node-\n' "$file"
              fi
              # 在setup-python之后添加缓存
              if grep -q 'actions/setup-python' "$file"; then
                sed -i '/actions\/setup-python@v5/a \      - name: Cache pip dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.cache/pip\n          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}\n          restore-keys: |\n            ${{ runner.os }}-pip-\n' "$file"
              fi
            fi
            # 添加超时设置
            if ! grep -q 'timeout-minutes' "$file"; then
              # 在jobs部分添加超时
              sed -i '/runs-on:/a \    timeout-minutes: 30\n' "$file"
            fi
          done

      - name: Update documentation
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'documentation'
        run: |
          # 更新工作流文档
          if [ -f ".github/WORKFLOWS_DOCUMENTATION.md" ]; then
            echo "Updating workflow documentation..."
            # 更新文档版本
            sed -i 's/version: v[0-9]\.[0-9]/version: v1.2/g' ".github/WORKFLOWS_DOCUMENTATION.md"
            # 更新更新日期
            TODAY=$(date +"%Y-%m-%d")
            sed -i "s/date: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/date: $TODAY/g" ".github/WORKFLOWS_DOCUMENTATION.md"
          else
            echo "Creating workflow documentation..."
            cat > .github/WORKFLOWS_DOCUMENTATION.md << EOF
# 工作流文档

## 文档信息
- **版本**: v1.2
- **创建日期**: $(date +"%Y-%m-%d")
- **更新日期**: $(date +"%Y-%m-%d")
- **作者**: GitHub Actions

## 目录结构

### .github 目录
- **actions/**: 自定义 Action
- **actions-config/**: Actions 配置文件
- **workflows/**: 工作流文件
- **scripts/**: 辅助脚本

## 工作流分类

### CI/CD 工作流
- **ci.yml**: CI 工作流
- **ci@backend.yml**: 后端 CI 工作流
- **ci@main.yml**: 主分支 CI 工作流
- **deploy.yml**: 部署工作流
- **release.yml**: 发布工作流

### 测试工作流
- **deno.yml**: Deno 测试工作流
- **idl.yaml**: IDL 测试工作流

### 安全工作流
- **security-scan.yml**: 安全扫描工作流
- **license-check.yaml**: 许可证检查工作流

### 其他工作流
- **claude.yml**: Claude PR 助手工作流
- **workflow-fixer.yml**: 工作流修复工作流

## Actions 配置

### 允许的来源
- actions/checkout
- actions/setup-node
- actions/setup-python
- actions/cache
- actions/upload-artifact
- actions/download-artifact
- github/codeql-action
- actions/dependency-review-action
- reviewdog/reviewdog
- codecov/codecov-action
- 8398a7/action-slack
- actions/github-script

### 已安装的 Actions
- **actions/checkout@v4**: 基础代码检出
- **actions/setup-node@v5**: Node.js 环境设置
- **actions/setup-python@v5**: Python 环境设置
- **actions/cache@v4**: 依赖缓存
- **actions/upload-artifact@v4**: 上传构建产物
- **actions/download-artifact@v4**: 下载构建产物
- **github/codeql-action@v3**: 代码安全扫描
- **actions/dependency-review-action@v4**: 依赖安全检查
- **reviewdog/reviewdog@v0.16.0**: 代码质量检查
- **codecov/codecov-action@v4**: 测试覆盖率报告
- **8398a7/action-slack@v3**: 工作流通知
- **actions/github-script@v7**: GitHub API 脚本

### 自定义 Actions
- **action-fixer**: 自动检测和修复工作流错误

## 安全策略

### 版本管理
- 强制使用固定版本号
- 定期检查安全更新
- 避免使用 `@master` 或 `@latest`

### 权限管理
- 最小权限原则
- 明确的权限配置
- 定期权限审计

### 依赖管理
- 定期更新依赖
- 依赖安全扫描
- 避免使用有漏洞的依赖

## 使用建议

### CI 工作流
- 增量构建
- 并行测试
- 缓存优化

### 部署工作流
- 安全扫描
- 部署前检查
- 部署后验证

### 安全工作流
- 定期扫描
- 及时修复漏洞
- 安全报告

## 优化方向

1. **工作流整合**: 合并相似的工作流，减少重复
2. **安全增强**: 增加更多安全检查点
3. **性能优化**: 进一步优化缓存和并行执行
4. **监控增强**: 添加更多监控和通知
5. **自动化增强**: 增加更多自动化修复功能

## 故障排除

### 常见错误
1. **权限错误**: 检查工作流权限配置
2. **语法错误**: 使用 YAML 验证工具检查语法
3. **依赖错误**: 检查依赖配置和网络连接
4. **超时错误**: 增加超时设置或优化执行时间

### 解决方案
1. **权限问题**: 添加适当的权限配置
2. **语法问题**: 使用 `reviewdog/reviewdog` 自动修复
3. **依赖问题**: 增加缓存和重试机制
4. **超时问题**: 优化执行步骤和增加超时设置
EOF
          fi

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push fixes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .github/workflows/
          git add .github/actions-config/
          git add .github/WORKFLOWS_DOCUMENTATION.md
          git commit -m "fix: auto-correct workflow configuration errors"
          # 使用PAT推送以避免权限问题
          if [ -n "${{ secrets.PAT }}" ]; then
            git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:main
          else
            git push origin main
          fi
        env:
          PAT: ${{ secrets.PAT }}

      - name: Upload fix report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-fix-report
          path: |
            .github/actions-config/
            .github/WORKFLOWS_DOCUMENTATION.md

      - name: Send notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
