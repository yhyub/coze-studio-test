name: Workflow Error Auto-Fixer

on:
  # 1. ç›‘å¬å·¥ä½œæµå¤±è´¥äº‹ï¿½?  workflow_run:
    workflows: ["**"]  # ç›‘æ§æ‰€æœ‰å·¥ä½œæµ
    types:
      - completed
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘è¯Šæ–­
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: 'å¤±è´¥çš„å·¥ä½œæµè¿è¡ŒID'
        required: true
      force_fix:
        description: 'å¼ºåˆ¶å°è¯•ä¿®å¤'
        required: false
        default: 'false'

jobs:
  analyze-and-fix:
    if: >-
      github.event.workflow_run.conclusion == 'failure' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      issues: write
      workflows: write
      checks: write
    steps:
      - name: æ”¶é›†å¤±è´¥å·¥ä½œæµä¿¡æ¯        id: gather-info
        run: |
          # è·å–å·¥ä½œæµè¿è¡ŒID
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_ID="${{ github.event.inputs.workflow_run_id }}"
            FORCE_FIX="${{ github.event.inputs.force_fix }}"
          else
            RUN_ID="${{ github.event.workflow_run.id }}"
            FORCE_FIX="false"
          fi
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "force_fix=$FORCE_FIX" >> $GITHUB_OUTPUT
          
          # è·å–å¤±è´¥å·¥ä½œæµçš„è¯¦ç»†ä¿¡æ¯
          RESPONSE=$(gh api /repos/${{ github.repository }}/actions/runs/$RUN_ID)
          echo "workflow_name=$(echo $RESPONSE | jq -r '.name')" >> $GITHUB_OUTPUT
          echo "head_branch=$(echo $RESPONSE | jq -r '.head_branch')" >> $GITHUB_OUTPUT
          echo "trigger_by=$(echo $RESPONSE | jq -r '.actor.login')" >> $GITHUB_OUTPUT

      - name: è·å–è¯¦ç»†é”™è¯¯æ—¥å¿—        id: get-logs
        run: |
          # ä¸‹è½½å¹¶åˆ†ææ—¥å¿—          gh run view ${{ steps.gather-info.outputs.run_id }} --log-failed > failed_logs.txt
          
          # æå–å…³é”®é”™è¯¯ä¿¡æ¯
          ERROR_PATTERN=$(grep -i -E "error:|failed|syntax|permission|not found|command not found" failed_logs.txt | head -5)
          echo "error_pattern=$ERROR_PATTERN" >> $GITHUB_OUTPUT
          
          # åˆ†ç±»é”™è¯¯ç±»å‹
          if echo "$ERROR_PATTERN" | grep -q -i "syntax\|YAML"; then
            ERROR_TYPE="yaml_syntax"
          elif echo "$ERROR_PATTERN" | grep -q -i "permission\|denied\|403\|401"; then
            ERROR_TYPE="permission"
          elif echo "$ERROR_PATTERN" | grep -q -i "not found\|command not found\|ENOENT"; then
            ERROR_TYPE="dependency"
          elif echo "$ERROR_PATTERN" | grep -q -i "timeout\|canceled"; then
            ERROR_TYPE="timeout"
          else
            ERROR_TYPE="unknown"
          fi
          
          echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          cat failed_logs.txt >> $GITHUB_STEP_SUMMARY

      - name: æ™ºèƒ½è¯Šæ–­ä¸ä¿®å¤å»ºè®®        id: diagnose
        run: |
          ERROR_TYPE="${{ steps.get-logs.outputs.error_type }}"
          FIX_STRATEGY="none"
          FIX_DESCRIPTION=""
          
          case $ERROR_TYPE in
            yaml_syntax)
              FIX_STRATEGY="patch_yaml"
              FIX_DESCRIPTION="æ£€æµ‹åˆ°YAMLè¯­æ³•é”™è¯¯ï¼Œå°†å°è¯•è‡ªåŠ¨ä¿®å¤"
              ;;
            permission)
              FIX_STRATEGY="update_permissions"
              FIX_DESCRIPTION="æ£€æµ‹åˆ°æƒé™é—®é¢˜ï¼Œå°†è°ƒæ•´å·¥ä½œæµæƒé™"
              ;;
            dependency)
              FIX_STRATEGY="update_dependencies"
              FIX_DESCRIPTION="æ£€æµ‹åˆ°ä¾èµ–é—®é¢˜ï¼Œå°†æ›´æ–°ä¾èµ–é…ç½®"
              ;;
            timeout)
              FIX_STRATEGY="increase_timeout"
              FIX_DESCRIPTION="æ£€æµ‹åˆ°è¶…æ—¶é—®é¢˜ï¼Œå°†å¢åŠ è¶…æ—¶æ—¶é—´"
              ;;
            *)
              FIX_STRATEGY="manual_review"
              FIX_DESCRIPTION="æ— æ³•è‡ªåŠ¨è¯Šæ–­ï¼Œéœ€è¦äººå·¥æ£€æŸ¥"
              ;;
          esac
          
          echo "fix_strategy=$FIX_STRATEGY" >> $GITHUB_OUTPUT
          echo "fix_description=$FIX_DESCRIPTION" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
          echo "## ğŸ©º å·¥ä½œæµé”™è¯¯è¯Šæ–­æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "**å¤±è´¥å·¥ä½œæµ**: ${{ steps.gather-info.outputs.workflow_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**é”™è¯¯ç±»å‹**: $ERROR_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿®å¤ç­–ç•¥**: $FIX_STRATEGY" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿®å¤æè¿°**: $FIX_DESCRIPTION" >> $GITHUB_STEP_SUMMARY

      - name: æ‰§è¡Œè‡ªåŠ¨ä¿®å¤
        if: steps.diagnose.outputs.fix_strategy != 'manual_review' && (steps.diagnose.outputs.fix_strategy != 'none' || steps.gather-info.outputs.force_fix == 'true')
        run: |
          mkdir -p fixes
          WORKFLOW_PATH=".github/workflows/${{ steps.gather-info.outputs.workflow_name }}"
          
          case "${{ steps.diagnose.outputs.fix_strategy }}" in
            patch_yaml)
              # ä¿®å¤å¸¸è§çš„YAMLè¯­æ³•é”™è¯¯
              echo "æ­£åœ¨ä¿®å¤YAMLè¯­æ³•..."
              python3 << 'EOF'
              # è¿™é‡Œæ”¾ç½®YAMLä¿®å¤é€»è¾‘
              print("YAMLä¿®å¤é€»è¾‘å¾…å®ç°")
              EOF
              ;;
            
            update_permissions)
              # æ›´æ–°å·¥ä½œæµæƒé™
              echo "æ›´æ–°å·¥ä½œæµæƒé™.."
              cat > fixes/permissions_patch.yaml << 'EOF'
              # å»ºè®®çš„æƒé™æ›´æ–°
              permissions:
                contents: write
                actions: read
                checks: write
              EOF
              ;;
            
            update_dependencies)
              # æ›´æ–°ä¾èµ–ç‰ˆæœ¬
              echo "æ›´æ–°ä¾èµ–é…ç½®..."
              cat > fixes/dependencies_fix.sh << 'EOF'
              # è‡ªåŠ¨æ›´æ–°å¸¸è§ä¾èµ–
              sed -i 's/actions\/checkout@v2/actions\/checkout@v4/g' $WORKFLOW_PATH
              sed -i 's/node-version: 14/node-version: 20/g' $WORKFLOW_PATH
              EOF
              ;;
          esac
          
          echo "ä¿®å¤è„šæœ¬å·²ç”Ÿæˆåˆ° fixes/ ç›®å½•"

      - name: åˆ›å»ºä¿®å¤PR
        if: steps.diagnose.outputs.fix_strategy != 'manual_review' && steps.diagnose.outputs.fix_strategy != 'none'
        run: |
          # åˆ›å»ºæ–°åˆ†æ”¯
          BRANCH_NAME="fix/workflow-${{ steps.gather-info.outputs.run_id }}-$(date +%s)"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b $BRANCH_NAME
          
          # åº”ç”¨ä¿®å¤
          if [ -f fixes/dependencies_fix.sh ]; then
            bash fixes/dependencies_fix.sh
          fi
          
          # æäº¤æ›´æ”¹
          git add .
          git commit -m "fix(workflow): è‡ªåŠ¨ä¿®å¤ ${{ steps.gather-info.outputs.workflow_name }} å·¥ä½œæµé”™è¯¯
          
          é”™è¯¯ç±»å‹: ${{ steps.diagnose.outputs.error_type }}
          ä¿®å¤ç­–ç•¥: ${{ steps.diagnose.outputs.fix_strategy }}
          åŸå§‹è¿è¡ŒID: ${{ steps.gather-info.outputs.run_id }}"
          
          git push origin $BRANCH_NAME
          
          # åˆ›å»ºPR
          gh pr create \
            --title "ğŸ”§ è‡ªåŠ¨ä¿®å¤: ${{ steps.gather-info.outputs.workflow_name }} å·¥ä½œæµé”™è¯¯" \
            --body "## è‡ªåŠ¨ä¿®å¤å·¥ä½œæµé”™è¯¯
            æ­¤PRç”±å·¥ä½œæµé”™è¯¯è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿåˆ›å»º
            
            **è¯¦ç»†ä¿¡æ¯:**
            - å¤±è´¥å·¥ä½œæµ: ${{ steps.gather-info.outputs.workflow_name }}
            - è¿è¡ŒID: ${{ steps.gather-info.outputs.run_id }}
            - é”™è¯¯ç±»å‹: ${{ steps.diagnose.outputs.error_type }}
            - ä¿®å¤ç­–ç•¥: ${{ steps.diagnose.outputs.fix_strategy }}
            
            **æ›´æ”¹æ‘˜è¦:**
            $(find fixes -type f -exec echo '- {}' \; )"
          
          echo "PRå·²åˆ›å»º: $BRANCH_NAME"

      - name: åˆ›å»ºé—®é¢˜å·¥å•ï¼ˆéœ€è¦äººå·¥å¹²é¢„æ—¶ï¼‰        if: steps.diagnose.outputs.fix_strategy == 'manual_review'
        run: |
          gh issue create \
            --title "éœ€è¦äººå·¥æ£€æŸ¥: ${{ steps.gather-info.outputs.workflow_name }} å·¥ä½œæµå¤±è´¥" \
            --body "å·¥ä½œæµ ${{ steps.gather-info.outputs.workflow_name }} è¿è¡Œå¤±è´¥ï¼Œä½†æ— æ³•è‡ªåŠ¨ä¿®å¤ã€‚
            
            è¿è¡ŒID: ${{ steps.gather-info.outputs.run_id }}
            è§¦å‘äºº: ${{ steps.gather-info.outputs.trigger_by }}
            åˆ†æ”¯: ${{ steps.gather-info.outputs.head_branch }}
            
            é”™è¯¯æ‘˜è¦:
            \`\`\`
            ${{ steps.get-logs.outputs.error_pattern }}
            \`\`\`
            
            è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤ã€‚" \
            --label "workflow-error,needs-triage"

      - name: å‘é€é€šçŸ¥
        run: |
          # å‘é€åˆ°Slack/Teamsç­‰ï¼ˆå¯é€‰ï¼‰
          echo "é€šçŸ¥å·²å‘é€"
          # å®é™…å®ç°å¯èƒ½éœ€è¦webhook
          
          # æ€»ç»“æŠ¥å‘Š
          echo "## ğŸ“‹ ä¿®å¤æ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- è¯Šæ–­å®Œæˆ: ${{ steps.diagnose.outputs.fix_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿®å¤å°è¯•: ${{ steps.diagnose.outputs.fix_description }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ä¿®å¤æµç¨‹å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ä¿®å¤æµç¨‹é‡åˆ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ ä¿®å¤æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: workflow-fix-report-${{ steps.gather-info.outputs.run_id }}
          path: |
            fixes/
            failed_logs.txt\n
