name: All-in-One Workflow Fixer
# This workflow integrates all workflow execution logic
# It works seamlessly with the main configuration file eawsrdfchgvjhrrdfgh.yml
# All configurations are fully integrated and redundant-free

on:
  workflow_dispatch:
    inputs:
      fix-type:
        description: 'Type of fix to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - permissions
          - security
          - deployment
          - dependencies
          - performance
          - documentation
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - '.github/actions-config/**'
  schedule:
    - cron: '0 12 * * *'  # 每天中午12点运行
permissions:
  contents: write
  actions: read
  pull-requests: read
  checks: read
  deployments: read
  issues: read
  packages: read
  repository-projects: read
  security-events: write
  statuses: read

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq pyyaml requests
          npm install -g yaml-lint

      - name: Validate actions-config directory
        run: |
          if [ ! -d ".github/actions-config" ]; then
            echo "Creating actions-config directory..."
            mkdir -p .github/actions-config
          fi
          
          if [ ! -f ".github/actions-config/actions.yaml" ]; then
            echo "Creating actions.yaml file..."
            printf 'allowed_sources:\n  - actions/checkout\n  - actions/setup-node\n  - actions/setup-python\n  - actions/cache\n  - actions/upload-artifact\n  - actions/download-artifact\n  - github/codeql-action\n  - actions/dependency-review-action\n  - reviewdog/reviewdog\n  - codecov/codecov-action\n  - 8398a7/action-slack\n  - actions/github-script\n\ninstalled_actions:\n  - name: actions/checkout\n    version: v4\n    source: actions/checkout\n    usage: 每天使用\n    security: 已审核\n    workflows: []\n\ncustom_actions:\n  directory: ".github/actions"\n  list: []\n' > .github/actions-config/actions.yaml
          fi

      - name: Fix workflow syntax errors
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'syntax' }}
        uses: reviewdog/reviewdog@v0.16.0
        with:
          reporter: github-pr-review
          level: error
          workdir: .github/workflows/

      - name: Fix expression syntax
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'syntax' }}
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if grep -q 'if: steps\.' "$file"; then
              echo "Fixing expression syntax in $file..."
              sed -i 's/if: steps\./if: \${{ steps\. }}/g' "$file"
              sed -i 's/!= \'\'/ != \'\' }}/g' "$file"
            fi
          done

      - name: Fix permission issues
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'permissions' }}
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Checking permissions in $file..."
            if grep -q 'permissions: {}' "$file"; then
              echo "Fixing empty permissions in $file..."
              sed -i 's/permissions: {}/permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read/g' "$file"
            fi
            if ! grep -q 'permissions:' "$file"; then
              echo "Adding basic permissions to $file..."
              sed -i '/jobs:/i \permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read\n' "$file"
            fi
          done

      - name: Run security scan
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security' }}
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, go
          queries: security-extended,security-and-quality
          setup-python-dependencies: true

      - name: Analyze code
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security' }}
        uses: github/codeql-action/analyze@v3
        with:
          category: /language:javascript,/language:python,/language:go

      - name: Dependency review
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'dependencies' || github.event.inputs.fix-type == 'security' }}
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT,Apache-2.0,BSD-3-Clause

      - name: Scan for secrets
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security' }}
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          fail-on-findings: true
          verbose: true

      - name: Update Action versions
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'dependencies' }}
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Updating Action versions in $file..."
            sed -i 's/actions\/checkout@v[0-9]\+/actions\/checkout@v4/g' "$file"
            sed -i 's/actions\/setup-node@v[0-9]\+/actions\/setup-node@v5/g' "$file"
            sed -i 's/actions\/setup-python@v[0-9]\+/actions\/setup-python@v5/g' "$file"
            sed -i 's/actions\/cache@v[0-9]\+/actions\/cache@v4/g' "$file"
            sed -i 's/actions\/upload-artifact@v[0-9]\+/actions\/upload-artifact@v4/g' "$file"
            sed -i 's/actions\/download-artifact@v[0-9]\+/actions\/download-artifact@v4/g' "$file"
          done

      - name: Optimize workflow performance
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'performance' }}
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            echo "Optimizing performance in $file..."
            if ! grep -q 'actions/cache' "$file"; then
              if grep -q 'actions/setup-node' "$file"; then
                sed -i '/actions\/setup-node@v5/a \      - name: Cache npm dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.npm\n          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}\n          restore-keys: |\n            ${{ runner.os }}-node-\n' "$file"
              fi
              if grep -q 'actions/setup-python' "$file"; then
                sed -i '/actions\/setup-python@v5/a \      - name: Cache pip dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.cache/pip\n          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}\n          restore-keys: |\n            ${{ runner.os }}-pip-\n' "$file"
              fi
            fi
            if ! grep -q 'timeout-minutes' "$file"; then
              sed -i '/runs-on:/a \    timeout-minutes: 30\n' "$file"
            fi
          done

      - name: Update documentation
        if: ${{ github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'documentation' }}
        run: |
          if [ -f ".github/WORKFLOWS_DOCUMENTATION.md" ]; then
            echo "Updating workflow documentation..."
            TODAY=$(date +"%Y-%m-%d")
            sed -i "s/date: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/date: $TODAY/g" ".github/WORKFLOWS_DOCUMENTATION.md"
          else
            echo "Creating workflow documentation..."
            TODAY=$(date +"%Y-%m-%d")
            echo '# 工作流文档' > .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 文档信息' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **版本**: v1.2' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **创建日期**: ${TODAY}" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **更新日期**: ${TODAY}" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **作者**: GitHub Actions' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 目录结构' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### .github 目录' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/**: 自定义Action' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions-config/**: Actions 配置文件' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **workflows/**: 工作流文件' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **scripts/**: 辅助脚本' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 工作流分类' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### CI/CD 工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **ci.yml**: CI 工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **ci@backend.yml**: 后端 CI 工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **ci@main.yml**: 主分支 CI 工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **deploy.yml**: 部署工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **release.yml**: 发布工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 测试工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **deno.yml**: Deno 测试工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **idl.yaml**: IDL 测试工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 安全工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **security-scan.yml**: 安全扫描工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **license-check.yaml**: 许可证检查工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 其他工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **claude.yml**: Claude PR 助手工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **workflow-fixer.yml**: 工作流修复工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## Actions 配置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 允许的来源' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/checkout' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/setup-node' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/setup-python' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/cache' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/upload-artifact' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/download-artifact' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- github/codeql-action' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/dependency-review-action' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- reviewdog/reviewdog' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- codecov/codecov-action' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 8398a7/action-slack' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- actions/github-script' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 已安装的 Actions' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/checkout@v4**: 基础代码检出' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/setup-node@v5**: Node.js 环境设置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/setup-python@v5**: Python 环境设置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/cache@v4**: 依赖缓存' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/upload-artifact@v4**: 上传构建产物' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/download-artifact@v4**: 下载构建产物' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **github/codeql-action@v3**: 代码安全扫描' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/dependency-review-action@v4**: 依赖安全检查' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **reviewdog/reviewdog@v0.16.0**: 代码质量检查' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **codecov/codecov-action@v4**: 测试覆盖率报告' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **8398a7/action-slack@v3**: 工作流通知' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **actions/github-script@v7**: GitHub API 脚本' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 自定义Actions' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- **action-fixer**: 自动检测和修复工作流错误' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 安全策略' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 版本管理' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 强制使用固定版本号' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 定期检查安全更新' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 避免使用 `@master` 或 `@latest`' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 权限管理' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 最小权限原则' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 明确的权限配置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 定期权限审计' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 依赖管理' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 定期更新依赖' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 依赖安全扫描' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 避免使用有漏洞的依赖' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 使用建议' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### CI 工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 增量构建' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 并行测试' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 缓存优化' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 部署工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 安全扫描' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 部署前检查' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 部署后验证' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 安全工作流' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 定期扫描' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 及时修复漏洞' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '- 安全报告' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 优化方向' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '1. **工作流整合**: 合并相似的工作流，减少重复' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '2. **安全增强**: 增加更多安全检查点' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '3. **性能优化**: 进一步优化缓存和并行执行' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '4. **监控增强**: 添加更多监控和通知' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '5. **自动化增强**: 增加更多自动化修复功能' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '## 故障排除' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 常见错误' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '1. **权限错误**: 检查工作流权限配置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '2. **语法错误**: 使用 YAML 验证工具检查语法' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '3. **依赖错误**: 检查依赖配置和网络连接' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '4. **超时错误**: 增加超时设置或优化执行时间' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '### 解决方案' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '1. **权限问题**: 添加适当的权限配置' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '2. **语法问题**: 使用 `reviewdog/reviewdog` 自动修复' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '3. **依赖问题**: 增加缓存和重试机制' >> .github/WORKFLOWS_DOCUMENTATION.md
            echo '4. **超时问题**: 优化执行步骤和增加超时设置' >> .github/WORKFLOWS_DOCUMENTATION.md
          fi

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: get_changed_files
        if: ${{ steps.check_changes.outputs.changes == 'true' }}
        run: |
          echo "changed_files=$(git diff --name-only | grep -E '\.github/(workflows|actions-config)/|WORKFLOWS_DOCUMENTATION\.md' | tr '\n' ' ' | sed 's/ $//')" >> $GITHUB_OUTPUT

      - name: Push changes using GitHub API
        if: ${{ steps.check_changes.outputs.changes == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repository = process.env.GITHUB_REPOSITORY;
            const branch = 'main';
            
            const changedFiles = `${{ steps.get_changed_files.outputs.changed_files }}`.split(' ').filter(Boolean);
            
            if (changedFiles.length === 0) {
              console.log('No relevant files changed, skipping push');
              return;
            }
            
            console.log(`Pushing changes to ${changedFiles.length} files...`);
            
            for (const file of changedFiles) {
              try {
                const fs = require('fs');
                const content = fs.readFileSync(file, 'utf8');
                
                let sha = undefined;
                try {
                  const { data: existingFile } = await github.rest.repos.getContent({
                    owner: repository.split('/')[0],
                    repo: repository.split('/')[1],
                    path: file,
                    ref: branch
                  });
                  sha = existingFile.sha;
                } catch (error) {
                  console.log('File ' + file + ' doesn\'t exist, will create it');
                }
                
                await github.rest.repos.createOrUpdateFileContents({
                  owner: repository.split('/')[0],
                  repo: repository.split('/')[1],
                  path: file,
                  message: 'fix: auto-correct workflow configuration errors',
                  content: Buffer.from(content).toString('base64'),
                  branch: branch,
                  sha: sha
                });
                
                console.log('Successfully updated ' + file);
              } catch (error) {
                console.error('Error updating ' + file + ': ' + error.message);
              }
            }
            
            console.log('All changes pushed successfully!');

      - name: Upload fix report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-fix-report
          path: |
            .github/actions-config/
            .github/WORKFLOWS_DOCUMENTATION.md

      - name: Send notification
        if: ${{ failure() }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
