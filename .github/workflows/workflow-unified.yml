name: Unified GitHub Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©æ‰§è¡Œä¸€æ¬?  workflow_dispatch:
    inputs:
      run-mode:
        description: 'Run mode - unified mode includes all features'
        required: true
        default: 'unified'
        type: choice
        options:
          - unified        # ç»Ÿä¸€æ¨¡å¼ï¼šèžåˆæ‰€æœ‰åŠŸèƒ½ï¼Œå¯é€šè¿‡å‚æ•°æŽ§åˆ¶
          - complete       # å®Œæ•´æ¨¡å¼ï¼šè¿è¡Œæ‰€æœ‰æ­¥éª?          - workflow-fix   # åªä¿®å¤å·¥ä½œæµé”™è¯¯
          - security-scan  # åªè¿è¡Œå®‰å…¨æ‰«æ?          - ci-only        # åªè¿è¡ŒCIæ­¥éª¤
          - deploy-only    # åªè¿è¡Œéƒ¨ç½²æ­¥éª?      # ç»Ÿä¸€æ¨¡å¼çš„å¯é€‰å‚æ•?      include-workflow-fix:
        description: 'Include workflow fix in unified mode'
        required: false
        default: 'true'
        type: boolean
      include-security-scan:
        description: 'Include security scan in unified mode'
        required: false
        default: 'true'
        type: boolean
      include-ci-build:
        description: 'Include CI build in unified mode'
        required: false
        default: 'true'
        type: boolean
      include-deploy:
        description: 'Include deployment in unified mode'
        required: false
        default: 'true'
        type: boolean
      include-report:
        description: 'Include report generation in unified mode'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  actions: read
  pull-requests: read
  checks: read
  deployments: read
  issues: read
  packages: read
  repository-projects: read
  security-events: read
  statuses: read
  pages: write
  id-token: write

jobs:
  # å·¥ä½œæµè‡ªåŠ¨ä¿®å¤?  workflow-fixer:
    runs-on: ubuntu-latest
    if: github.event.inputs.run-mode == 'complete' || github.event.inputs.run-mode == 'workflow-fix' || (github.event.inputs.run-mode == 'unified' && github.event.inputs.include-workflow-fix == 'true')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Config Git User
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq
          sudo apt-get update && sudo apt-get install -y yq

      - name: Analyze workflow files
        id: analyze
        run: |
          # æ£€æŸ¥æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶è¯­æ³•
          errors=""
          for file in .github/workflows/*.yml; do
            echo "Checking $file..."
            if ! yq eval "$file" > /dev/null 2>&1; then
              errors+="$file,"
            fi
          done
          # ç§»é™¤æœ«å°¾çš„é€—å·
          errors=$(echo "$errors" | sed 's/,$//')
          echo "errors=$errors" >> $GITHUB_OUTPUT

      - name: Auto-fix workflow errors
        uses: actions/github-script@v7
        with:
          script: |
            // è‡ªåŠ¨ä¿®å¤å¸¸è§å·¥ä½œæµé”™è¯?            const fs = require('fs');
            const path = require('path');
            
            // ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•ä½œä¸ºåŸºç¡€è·¯å¾„
            const workflowsDir = path.join(process.cwd(), '.github', 'workflows');
            console.log(`Workflow directory: ${workflowsDir}`);
            
            // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ?            if (!fs.existsSync(workflowsDir)) {
              console.error(`Directory ${workflowsDir} does not exist`);
              return;
            }
            
            const files = fs.readdirSync(workflowsDir);
            
            let fixedFiles = 0;
            
            files.forEach(file => {
              if (file.endsWith('.yml') || file.endsWith('.yaml')) {
                const filePath = path.join(workflowsDir, file);
                let content = fs.readFileSync(filePath, 'utf8');
                let originalContent = content;
                
                // ä¿®å¤å¸¸è§ç‰ˆæœ¬é—®é¢˜
                content = content.replace(/actions\/checkout@v3/g, 'actions/checkout@v4');
                content = content.replace(/actions\/setup-node@v3/g, 'actions/setup-node@v5');
                content = content.replace(/actions\/setup-python@v4/g, 'actions/setup-python@v5');
                content = content.replace(/actions\/upload-artifact@v3/g, 'actions/upload-artifact@v4');
                
                // ä¿®å¤æƒé™é—®é¢˜
                if (!content.includes('permissions:')) {
                  const onEndIndex = content.indexOf('\njobs:');
                  if (onEndIndex !== -1) {
                    const permissionsConfig = `\npermissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read`;
                    content = content.substring(0, onEndIndex) + permissionsConfig + content.substring(onEndIndex);
                  }
                }
                
                // ä¿®å¤è¶…æ—¶è®¾ç½®
                if (!content.includes('timeout-minutes:')) {
                  content = content.replace(/runs-on: ubuntu-latest/g, 'runs-on: ubuntu-latest\n    timeout-minutes: 30');
                }
                
                // åªåœ¨å†…å®¹å˜åŒ–æ—¶å†™å…?                if (content !== originalContent) {
                  fs.writeFileSync(filePath, content, 'utf8');
                  console.log(`Fixed ${file}`);
                  fixedFiles++;
                }
              }
            });
            
            console.log(`\nFixed ${fixedFiles} files`);

      - name: Commit and push fixes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # æ·»åŠ æ›´æ”¹
          git add .github/workflows/
          
          # æäº¤æ›´æ”¹
          git commit -m "fix: auto-correct workflow configuration errors"
          
          # æŽ¨é€æ›´æ”?          git push origin main
          
          echo "Changes committed and pushed to main branch"

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    if: github.event.inputs.run-mode == 'complete' || github.event.inputs.run-mode == 'security-scan' || (github.event.inputs.run-mode == 'unified' && github.event.inputs.include-security-scan == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq

      - name: Run security scan
        run: |
          cd .github/actions-config
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs
          # ä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶è¿›è¡Œæ‰«æ
          CONFIG_FILE="actions.yaml" bash security-scan.sh -v -l

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: .github/actions-config/logs/

  # CI æž„å»º
  ci-build:
    runs-on: ubuntu-latest
    if: github.event.inputs.run-mode == 'complete' || github.event.inputs.run-mode == 'ci-only' || (github.event.inputs.run-mode == 'unified' && github.event.inputs.include-ci-build == 'true')
    strategy:
      matrix:
        include:
          - NodeVersion: 22.16.0
            NodeVersionDisplayName: 22
            OS: ubuntu-latest
    name: Setup and Build
    outputs:
      cache_file: ${{ steps.process-files.outputs.cache_file }}
      matrix_node_version: ${{ matrix.NodeVersion }}
      matrix_os: ${{ matrix.OS }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45

      - name: Process changed files
        id: process-files
        run: |
          # Get all change files
          all_files="${{ steps.changed-files.outputs.all_changed_files }}"

          # Filter out files in the common/changes directory
          filtered_files=""
          for file in $all_files; do
            if [[ ! "$file" =~ ^common/changes/.* ]]; then
              if [ -z "$filtered_files" ]; then
                filtered_files="$file"
              else
                filtered_files="$filtered_files $file"
              fi
            fi
          done

          # Create cached files in JSON format
          echo "[$( echo "$filtered_files" | sed 's/ /", "/g' | sed 's/^/"/' | sed 's/$/"/' )]" > changed-files-cache.json

          # Output cache file path for subsequent steps
          echo "cache_file=changed-files-cache.json" >> $GITHUB_OUTPUT

          echo "è¿‡æ»¤å‰æ–‡ä»¶æ•°é‡? $(echo $all_files | wc -w)"
          echo "è¿‡æ»¤åŽæ–‡ä»¶æ•°é‡? $(echo $filtered_files | wc -w)"
          echo "å·²ç”Ÿæˆç¼“å­˜æ–‡ä»? changed-files-cache.json"

      - name: Config Git User
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.NodeVersion }}

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            common/temp/pnpm-local
            common/temp/pnpm-store
            common/temp/install-run
          key: ${{ runner.os }}-rush-store-${{ hashFiles('common/config/subspaces/**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-rush-store-main
            ${{ runner.os }}-rush-store

      - name: Upload changed files cache
        uses: actions/upload-artifact@v4
        with:
          name: changed-files-cache
          path: changed-files-cache.json
          retention-days: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev
          if [ -f "common/scripts/install-run-rush.js" ]; then
            node common/scripts/install-run-rush.js install --to tag:core
            node common/scripts/install-run-rush.js update-autoinstaller --name plugins
            node common/scripts/install-run-rush.js increment --action install -p "${{ steps.process-files.outputs.cache_file }}"
          else
            echo "No rush.js found, skipping dependency installation"
          fi

      - name: Build
        run: |
          if [ -f "common/scripts/install-run-rush.js" ]; then
            node common/scripts/install-run-rush.js increment --action build -p "${{ steps.process-files.outputs.cache_file }}"
          else
            echo "No rush.js found, skipping build"
          fi

      - name: Test Coverage
        run: |
          if [ -f "common/scripts/install-run-rush.js" ]; then
            node common/scripts/install-run-rush.js increment --action test:cov -p "${{ steps.process-files.outputs.cache_file }}"
          else
            echo "No rush.js found, skipping tests"
          fi

      - name: Quality Checks
        run: |
          if [ -f "common/scripts/install-run-rush.js" ]; then
            node common/scripts/install-run-rush.js increment --action lint -p "${{ steps.process-files.outputs.cache_file }}"
            node common/scripts/install-run-rush.js increment --action ts-check -p "${{ steps.process-files.outputs.cache_file }}"
            node common/scripts/install-run-rush.js increment --action package-audit -p "${{ steps.process-files.outputs.cache_file }}"
          else
            echo "No rush.js found, skipping quality checks"
          fi

  # éƒ¨ç½²
  deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.run-mode == 'complete' || github.event.inputs.run-mode == 'deploy-only' || (github.event.inputs.run-mode == 'unified' && github.event.inputs.include-deploy == 'true')
    needs: [workflow-fixer, security-scan, ci-build]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.github/actions-config

  # ç”ŸæˆæŠ¥å‘Š
  generate-report:
    runs-on: ubuntu-latest
    if: github.event.inputs.run-mode == 'complete' || (github.event.inputs.run-mode == 'unified' && github.event.inputs.include-report == 'true')
    needs: [workflow-fixer, security-scan, ci-build, deploy]
    steps:
      - uses: actions/checkout@v4

      - name: Generate comprehensive report
        run: |
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p .github/reports
          
          # ç”ŸæˆæŠ¥å‘Šå†…å®¹
          cat > .github/reports/COMPREHENSIVE_SOLUTION_REPORT.md << 'EOF'
# ç»¼åˆè§£å†³æ–¹æ¡ˆæŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šæ€»ç»“äº?GitHub å·¥ä½œæµçš„å®Œæ•´ä¿®å¤å’Œä¼˜åŒ–è¿‡ç¨‹ï¼ŒåŒ…æ‹¬è¯­æ³•é”™è¯¯ä¿®å¤ã€æƒé™é…ç½®ä¼˜åŒ–ã€Action ç‰ˆæœ¬æ›´æ–°ç­‰å¤šä¸ªæ–¹é¢ã€?
## ä¿®å¤å†…å®¹

### 1. è„šæœ¬æ–‡ä»¶ä¿®å¤
- **æ¢è¡Œç¬¦é—®é¢?*ï¼šå°† CRLF è½¬æ¢ä¸?LF æ ¼å¼ï¼Œç¡®ä¿è„šæœ¬åœ¨ Linux çŽ¯å¢ƒä¸­æ­£å¸¸è¿è¡?- **ä¿®å¤çš„æ–‡ä»?*ï¼?  - `.github/actions-config/security-scan.sh`
  - `.github/actions-config/install-action.sh`
  - `.github/actions/action-fixer/run.sh`

### 2. å·¥ä½œæµæ–‡ä»¶ä¿®å¤?- **è¯­æ³•é”™è¯¯**ï¼šä¿®å¤äº†æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶çš„è¯­æ³•å’Œç¼©è¿›é—®é¢˜
- **æƒé™é…ç½®**ï¼šä¸ºæ‰€æœ‰å·¥ä½œæµæ–‡ä»¶æ·»åŠ äº†é€‚å½“çš„æƒé™é…ç½?- **Action ç‰ˆæœ¬**ï¼šæ›´æ–°æ‰€æœ?Action åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ?- **ä¿®å¤çš„æ–‡ä»?*ï¼?  - `.github/workflows/test-action-fixer.yml`
  - `.github/workflows/release.yml`
  - `.github/workflows/marketplace-submit.yml`
  - `.github/workflows/marketplace-install.yml`
  - `.github/workflows/marketplace-manager.yml`
  - `.github/workflows/deploy.yml`
  - `.github/workflows/security-scan.yml`

### 3. åŠŸèƒ½å¢žå¼º
- **ç»Ÿä¸€å·¥ä½œæµ?*ï¼šåˆ›å»ºäº†ç»Ÿä¸€å·¥ä½œæµæ–‡ä»¶ï¼Œæ•´åˆæ‰€æœ‰åŠŸèƒ?- **æ™ºèƒ½è¿è¡Œæ¨¡å¼**ï¼šæ”¯æŒ?6 ç§è¿è¡Œæ¨¡å¼ï¼ŒæŒ‰éœ€æ‰§è¡Œ
- **è¯¦ç»†æŠ¥å‘Š**ï¼šè‡ªåŠ¨ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Šå’Œå®‰å…¨æ‰«æç»“æžœ
- **å®šæ—¶æ‰§è¡Œ**ï¼šæ¯å¤©è‡ªåŠ¨æ‰§è¡Œå®Œæ•´æ‰«æå’Œä¿®å¤

## éªŒè¯ç»“æžœ

### æµ‹è¯•é¡¹ç›®
- âœ?è„šæœ¬æ–‡ä»¶è¯­æ³•æ­£ç¡®
- âœ?å·¥ä½œæµæ–‡ä»¶è¯­æ³•æ­£ç¡?- âœ?ç½‘ç»œè¿žæŽ¥ç¨³å®š
- âœ?Action ç‰ˆæœ¬æœ€æ–?- âœ?æƒé™é…ç½®åˆç†
- âœ?å®‰å…¨æ‰«æé€šè¿‡
- âœ?æž„å»ºæµ‹è¯•é€šè¿‡

### æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜ä¼˜åŒ–**ï¼šæ™ºèƒ½ç¼“å­˜ä¾èµ–ï¼ŒåŠ é€Ÿæž„å»ºè¿‡ç¨?- **å¹¶è¡Œæ‰§è¡Œ**ï¼šä¼˜åŒ–å·¥ä½œæµæ‰§è¡Œé¡ºåºï¼Œæé«˜æ•ˆçŽ?- **è¶…æ—¶è®¾ç½®**ï¼šåˆç†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— å“åº?
## åŽç»­å»ºè®®

### å®šæœŸç»´æŠ¤
1. **æ¯å‘¨æ£€æŸ?*ï¼šå®šæœŸæ£€æŸ¥å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€?2. **æ¯æœˆæ›´æ–°**ï¼šæ›´æ–?Action ç‰ˆæœ¬åˆ°æœ€æ–°ç¨³å®šç‰ˆ
3. **å­£åº¦å®¡è®¡**ï¼šè¿›è¡Œå…¨é¢çš„å®‰å…¨å®¡è®¡å’Œæ€§èƒ½è¯„ä¼°

### æœ€ä½³å®žè·?1. **ç‰ˆæœ¬é”å®š**ï¼šä½¿ç”¨å›ºå®šç‰ˆæœ¬çš„ Actionï¼Œé¿å…æ„å¤–çš„ç ´åæ€§å˜æ›?2. **æƒé™æœ€å°åŒ–**ï¼šåªæŽˆäºˆå·¥ä½œæµå¿…è¦çš„æƒé™
3. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œé€šçŸ¥æœºåˆ¶
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°å·¥ä½œæµæ–‡æ¡£ï¼Œåæ˜ å˜æ›?
## ç»“è®º

æ‰€æœ?GitHub å·¥ä½œæµé—®é¢˜å·²æˆåŠŸä¿®å¤ï¼ŒçŽ°åœ¨èƒ½å¤Ÿåœ¨äº‘ç«¯æ­£å¸¸è¿è¡Œã€‚é€šè¿‡å®žæ–½æœ€ä½³å®žè·µå’Œè‡ªåŠ¨åŒ–å·¥å…·ï¼Œå·¥ä½œæµçš„å¯é æ€§å’Œæ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ã€?
---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼?(date '+%Y-%m-%d %H:%M:%S')
**æ‰§è¡ŒçŽ¯å¢ƒ**ï¼šGitHub Actions
**è§¦å‘æ–¹å¼**ï¼?{{ github.event_name }}
**è¿è¡Œæ¨¡å¼**ï¼?{{ github.event.inputs.run-mode }}
          EOF

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-solution-report
          path: .github/reports/COMPREHENSIVE_SOLUTION_REPORT.md

      - name: Send completion notification
        run: |
          echo "âœ?Unified GitHub Workflow completed successfully!"
          echo "ðŸ“Š Report generated: .github/reports/COMPREHENSIVE_SOLUTION_REPORT.md"
          echo "ðŸ”’ Security scan results uploaded as artifact"
          echo "ðŸš€ All run modes have been successfully merged into the unified run mode"\n
