name: Global Workflow Auto-Fixer

on:
  workflow_dispatch:
    inputs:
      fix-scope:
        description: 'Scope of fix'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - current-repo
          - all-repos
      include-branches:
        description: 'Branches to include (comma-separated)'
        required: false
        default: 'main,master,develop'
      dry-run:
        description: 'Dry run (no changes)'
        required: true
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 0 * * 0'  # Weekly cleanup

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: write
  deployments: read
  issues: read
  packages: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  discover-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.discover.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install -g @octokit/rest
          pip install --upgrade pip
          pip install PyGithub
      
      - name: Discover GitHub repositories
        id: discover
        run: |
          if [ "${{ github.event.inputs.fix-scope }}" == "current-repo" ]; then
            echo "repos=[\"${{ github.repository }}\"]" >> $GITHUB_OUTPUT
          else
            # Use GitHub API to discover all user repositories
            cat > discover-repos.js << 'EOF'
            const { Octokit } = require('@octokit/rest');
            const fs = require('fs');
            
            async function main() {
              const octokit = new Octokit({
                auth: process.env.GITHUB_TOKEN
              });
              
              const repos = [];
              let page = 1;
              const perPage = 100;
              
              try {
                // Get user repositories
                while (true) {
                  const response = await octokit.rest.repos.listForAuthenticatedUser({
                    per_page: perPage,
                    page: page
                  });
                  
                  if (response.data.length === 0) break;
                  
                  response.data.forEach(repo => {
                    if (repo.permissions.admin || repo.permissions.maintain || repo.permissions.push) {
                      repos.push(repo.full_name);
                    }
                  });
                  
                  page++;
                }
                
                // Get organization repositories
                const orgs = await octokit.rest.orgs.listForAuthenticatedUser();
                for (const org of orgs.data) {
                  page = 1;
                  while (true) {
                    const response = await octokit.rest.repos.listForOrg({
                      org: org.login,
                      per_page: perPage,
                      page: page
                    });
                    
                    if (response.data.length === 0) break;
                    
                    response.data.forEach(repo => {
                      if (repo.permissions.admin || repo.permissions.maintain || repo.permissions.push) {
                        repos.push(repo.full_name);
                      }
                    });
                    
                    page++;
                  }
                }
                
                console.log(`Found ${repos.length} repositories with write access`);
                fs.writeFileSync('repos.json', JSON.stringify(repos));
                console.log('repos=' + JSON.stringify(repos));
                process.stdout.write('::set-output name=repos::' + JSON.stringify(repos) + '\n');
              } catch (error) {
                console.error('Error discovering repositories:', error.message);
                process.stdout.write('::set-output name=repos::["${{ github.repository }}"]\n');
              }
            }
            
            main();
            EOF
            
            node discover-repos.js
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  fix-workflows:
    needs: discover-repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJSON(needs.discover-repos.outputs.repos) }}
      max-parallel: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub yq pyyaml
          npm install -g @octokit/rest
      
      - name: Get branches
        id: get-branches
        run: |
          # Get branches to include
          include_branches="${{ github.event.inputs.include-branches }}"
          
          # Get all branches
          branches=$(git branch -r | grep -v HEAD | sed 's/origin\///' | tr '\n' ',')
          branches=${branches%,}
          
          # Filter branches
          if [ -n "$include_branches" ]; then
            filtered_branches=$(echo "$branches" | tr ',' '\n' | grep -E "$(echo "$include_branches" | tr ',' '|')" | tr '\n' ',')
            filtered_branches=${filtered_branches%,}
          else
            filtered_branches="$branches"
          fi
          
          echo "branches=$filtered_branches" >> $GITHUB_OUTPUT
          echo "Including branches: $filtered_branches"
      
      - name: Fix workflows in all branches
        run: |
          branches="${{ steps.get-branches.outputs.branches }}"
          dry_run="${{ github.event.inputs.dry-run }}"
          
          IFS=',' read -ra branch_array <<< "$branches"
          
          for branch in "${branch_array[@]}"; do
            echo "\n=== Processing branch: $branch ==="
            
            # Checkout branch
            if git checkout "$branch"; then
              # Find workflow files
              workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null || echo "")
              
              if [ -z "$workflow_files" ]; then
                echo "No workflow files found in .github/workflows directory"
                continue
              fi
              
              echo "Found workflow files: $workflow_files"
              
              # Fix each workflow file
              for file in $workflow_files; do
                echo "\n--- Fixing $file ---"
                
                # Read file content
                content=$(cat "$file")
                original_content="$content"
                
                # Fix common issues
                
                # 1. Fix workflows permission
                content=$(echo "$content" | sed 's/workflows: write\n//g')
                content=$(echo "$content" | sed 's/workflows: read\n//g')
                
                # 2. Fix expression syntax
                content=$(echo "$content" | sed 's|if: steps\.|if: ${{ steps\. }}|g')
                
                # 3. Fix secrets usage
                content=$(echo "$content" | sed 's|secrets\.|env\.|g')
                
                # 4. Update action versions
                content=$(echo "$content" | sed 's/actions\/checkout@v[0-9]\+/actions\/checkout@v4/g')
                content=$(echo "$content" | sed 's/actions\/setup-node@v[0-9]\+/actions\/setup-node@v5/g')
                content=$(echo "$content" | sed 's/actions\/setup-python@v[0-9]\+/actions\/setup-python@v5/g')
                content=$(echo "$content" | sed 's/actions\/cache@v[0-9]\+/actions\/cache@v4/g')
                content=$(echo "$content" | sed 's/actions\/upload-artifact@v[0-9]\+/actions\/upload-artifact@v4/g')
                content=$(echo "$content" | sed 's/actions\/download-artifact@v[0-9]\+/actions\/download-artifact@v4/g')
                content=$(echo "$content" | sed 's/actions\/github-script@v[0-9]\+/actions\/github-script@v7/g')
                
                # 5. Fix empty permissions
                content=$(echo "$content" | sed 's/permissions: {}/permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read/g')
                
                # 6. Add missing permissions
                if ! echo "$content" | grep -q 'permissions:'; then
                  content=$(echo "$content" | sed '/jobs:/i \permissions:\n  contents: read\n  actions: read\n  pull-requests: read\n  checks: read\n  deployments: read\n  issues: read\n  packages: read\n  repository-projects: read\n  security-events: read\n  statuses: read\n')
                fi
                
                # 7. Add timeout settings
                if ! echo "$content" | grep -q 'timeout-minutes'; then
                  content=$(echo "$content" | sed '/runs-on:/a \    timeout-minutes: 30\n')
                fi
                
                # Write changes if content changed
                if [ "$content" != "$original_content" ]; then
                  echo "Changes detected in $file"
                  
                  if [ "$dry_run" == "false" ]; then
                    echo "Writing changes to $file"
                    echo "$content" > "$file"
                    echo "File $file has been updated"
                  else
                    echo "[DRY RUN] Would update $file"
                    diff -u <(echo "$original_content") <(echo "$content")
                  fi
                else
                  echo "No changes needed for $file"
                fi
              done
              
              # Check for changes
              if [ "$dry_run" == "false" ]; then
                if git diff --quiet; then
                  echo "No changes to commit"
                else
                  echo "Committing changes to branch $branch"
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add .github/workflows/
                  git commit -m "fix: auto-correct workflow configuration errors"
                  git push origin "$branch"
                  echo "Changes pushed to branch $branch"
                fi
              else
                echo "[DRY RUN] Would check for changes in branch $branch"
                git diff
              fi
            else
              echo "Failed to checkout branch $branch"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-report:
    needs: fix-workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate fix report
        run: |
          mkdir -p reports
          echo "# Global Workflow Fix Report" > reports/global-fix-report.md
          echo "" >> reports/global-fix-report.md
          echo "## Report Details" >> reports/global-fix-report.md
          echo "- **Date**: $(date +"%Y-%m-%d %H:%M:%S")" >> reports/global-fix-report.md
          echo "- **Fix Scope**: ${{ github.event.inputs.fix-scope }}" >> reports/global-fix-report.md
          echo "- **Include Branches**: ${{ github.event.inputs.include-branches }}" >> reports/global-fix-report.md
          echo "- **Dry Run**: ${{ github.event.inputs.dry-run }}" >> reports/global-fix-report.md
          echo "- **Repositories**: $(echo '${{ needs.discover-repos.outputs.repos }}' | jq length)" >> reports/global-fix-report.md
          echo "" >> reports/global-fix-report.md
          echo "## Fixed Issues" >> reports/global-fix-report.md
          echo "1. Removed unsupported 'workflows' permission" >> reports/global-fix-report.md
          echo "2. Fixed expression syntax (steps. prefix)" >> reports/global-fix-report.md
          echo "3. Fixed secrets usage (replaced with env)" >> reports/global-fix-report.md
          echo "4. Updated action versions to latest compatible versions" >> reports/global-fix-report.md
          echo "5. Fixed empty permissions configuration" >> reports/global-fix-report.md
          echo "6. Added missing permissions section" >> reports/global-fix-report.md
          echo "7. Added timeout settings to jobs" >> reports/global-fix-report.md
          echo "" >> reports/global-fix-report.md
          echo "## Security Notes" >> reports/global-fix-report.md
          echo "- All fixes follow GitHub security best practices" >> reports/global-fix-report.md
          echo "- Minimal permissions principle applied" >> reports/global-fix-report.md
          echo "- Uses secure GitHub API authentication" >> reports/global-fix-report.md
          echo "- Rate limiting respected with max-parallel: 5" >> reports/global-fix-report.md
      
      - name: Upload fix report
        uses: actions/upload-artifact@v4
        with:
          name: global-fix-report
          path: reports/

  notify:
    needs: generate-report
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}\n
