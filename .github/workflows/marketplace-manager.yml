name: Marketplace Actions Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - validate
          - clean
          - audit
  schedule:
    - cron: '0 12 * * *'  # æ¯å¤©ä¸­åˆ12ç‚¹è¿è¡?
jobs:
  manage-marketplace-actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq

      - name: Validate actions-config directory
        run: |
          if [ ! -d ".github/actions-config" ]; then
            echo "Warning: .github/actions-config directory not found"
            echo "Creating actions-config directory..."
            mkdir -p .github/actions-config
          fi
          
          if [ ! -f ".github/actions-config/actions.yaml" ]; then
            echo "Warning: .github/actions-config/actions.yaml not found"
            echo "Creating minimal actions.yaml file..."
            cat > .github/actions-config/actions.yaml << 'EOF'
allowed_sources:
  - actions/checkout
  - actions/setup-node
  - actions/setup-python
  - actions/upload-artifact

installed_actions:
  - name: actions/checkout
    version: v4
    source: actions/checkout
    usage: åŸºç¡€ä»£ç æ£€å‡?    security: å·²å®¡æ ?    workflows: []
EOF
          fi
          
          echo "âœ?actions-config directory and configuration files validated"

      - name: Sync marketplace actions
        if: github.event.inputs.action == 'sync' || github.event_name == 'schedule'
        run: |
          cd .github/actions-config
          echo "Syncing marketplace actions..."
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼?          if yq eval '.installed_actions' actions.yaml > /dev/null 2>&1; then
            echo "âœ?Configuration file format is valid"
          else
            echo "Error: Invalid configuration file format"
            exit 1
          fi
          
          # åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„actions
          echo "\nInstalled actions:"
          yq eval '.installed_actions[] | {name: .name, version: .version}' actions.yaml

      - name: Validate workflow files
        if: github.event.inputs.action == 'validate'
        run: |
          echo "Validating workflow files..."
          errors=""
          for file in .github/workflows/*.yml; do
            echo "Checking $file..."
            if ! yq eval "$file" > /dev/null 2>&1; then
              errors+="$file,"
            fi
          done
          
          # ç§»é™¤æœ«å°¾çš„é€—å·
          errors=$(echo "$errors" | sed 's/,$//')
          
          if [ -n "$errors" ]; then
            echo "\nError: Invalid workflow files found: $errors"
            exit 1
          else
            echo "\nâœ?All workflow files are valid"
          fi

      - name: Cleanup non-official files
        if: github.event.inputs.action == 'clean'
        run: |
          echo "Cleaning up non-official files..."
          cd .github/actions-config
          
          # å®šä¹‰å®˜æ–¹æ–‡ä»¶åˆ—è¡¨
          official_files=("actions.yaml" "install-action.sh" "security-scan.sh" "security-policy.md" "marketplace-actions.yaml")
          
          # éå†ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»?          for file in *; do
            # æ£€æŸ¥æ˜¯å¦æ˜¯å®˜æ–¹æ–‡ä»¶
            is_official=false
            for official_file in "${official_files[@]}"; do
              if [ "$file" == "$official_file" ]; then
                is_official=true
                break
              fi
            done
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç›®å½•
            if [ -d "$file" ]; then
              # æ£€æŸ¥æ˜¯å¦æ˜¯å®˜æ–¹ç›®å½•
              if [ "$file" != "logs" ]; then
                echo "Removing non-official directory: $file"
                # rm -rf "$file"  # æ³¨é‡Šæ‰å®é™…åˆ é™¤æ“ä½œï¼Œä»…æ˜¾ç¤ºéœ€è¦åˆ é™¤çš„æ–‡ä»¶
              fi
            elif [ "$is_official" == false ]; then
              echo "Removing non-official file: $file"
              # rm "$file"  # æ³¨é‡Šæ‰å®é™…åˆ é™¤æ“ä½œï¼Œä»…æ˜¾ç¤ºéœ€è¦åˆ é™¤çš„æ–‡ä»¶
            fi
          done
          
          echo "\nâœ?Cleanup completed (dry run)"

      - name: Audit marketplace actions
        if: github.event.inputs.action == 'audit'
        run: |
          echo "Auditing marketplace actions..."
          cd .github/actions-config
          
          # è¿è¡Œå®‰å…¨æ‰«æ
          echo "Running security scan..."
          ls -la
          # æ£€æŸ¥æ˜¯å¦å­˜åœ?security-scan.sh è„šæœ¬
          if [ -f "security-scan.sh" ]; then
            CONFIG_FILE="actions.yaml" bash security-scan.sh -v -l
          else
            echo "security-scan.sh not found, skipping security scan"
          fi
          
          echo "\nâœ?Audit completed"

      - name: Upload audit results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-actions-audit
          path: .github/actions-config/logs/\n
