name: Comprehensive Repository Fixer

on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日运行一次
  workflow_dispatch:
    inputs:
      target-branch:
        description: 'Target branch to fix (leave blank for all branches)'
        required: false
        default: ''
      fix-type:
        description: 'Type of fixes to perform (all, files, workflows)'
        required: true
        default: 'all'

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write

jobs:
  discover-branches:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.list-branches.outputs.branches }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List all branches
        id: list-branches
        run: |
          if [ -n "${{ github.event.inputs.target-branch }}" ]; then
            echo "branches=${{ github.event.inputs.target-branch }}" >> $GITHUB_OUTPUT
          else
            BRANCHES=$(git branch -r | grep -v HEAD | sed 's/origin\///' | tr '\n' ' ')
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          fi

  fix-repository:
    needs: discover-branches
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ${{ fromJSON('"' + needs.discover-branches.outputs.branches + '"') }}
      fail-fast: false
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl python3 python3-pip
          pip3 install --upgrade pip
          pip3 install yamllint jsonlint flake8 pylint

      - name: Fix workflow files
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'workflows'
        run: |
          # Find all workflow files
          WORKFLOW_FILES=$(find .github/workflows -name "*.yml" -o -name "*.yaml")
          
          for file in $WORKFLOW_FILES; do
            echo "Processing workflow file: $file"
            
            # Validate and fix YAML syntax
            yamllint -f parsable $file || true
            
            # Fix common workflow issues
            python3 -c "import yaml; import os; file_path = '$file'; with open(file_path, 'r') as f: data = yaml.safe_load(f); if 'permissions' not in data: data['permissions'] = {'contents': 'read'}; if 'on' in data: if isinstance(data['on'], dict): if not data['on']: data['on'] = {'push': {'branches': ['main']}}; with open(file_path, 'w') as f: yaml.dump(data, f, default_flow_style=False)"
          done

      - name: Fix code files
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'files'
        run: |
          # Fix Python files
          python3 -m flake8 --count --select=E9,F63,F7,F82 --show-source --statistics . || true
          
          # Fix JSON files
          JSON_FILES=$(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.git/*")
          for file in $JSON_FILES; do
            jsonlint -q $file || true
          done
          
          # Fix YAML files (non-workflow)
          YAML_FILES=$(find . -name "*.yml" -o -name "*.yaml" | grep -v ".github/workflows")
          for file in $YAML_FILES; do
            yamllint -f parsable $file || true
          done

      - name: Check for broken references
        run: |
          # Check for broken links in markdown files
          MARKDOWN_FILES=$(find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*")
          for file in $MARKDOWN_FILES; do
            echo "Checking markdown file: $file"
            # Simple check for broken relative links
            grep -E "\[.*\]\(.*\)" $file | grep -v "http" | while read -r line; do
              LINK=$(echo $line | sed -E 's/.*\[(.*)\]\((.*)\).*/\2/')
              if [[ -n "$LINK" && ! -f "$LINK" && ! -d "$LINK" ]]; then
                echo "Potential broken link in $file: $LINK"
              fi
            done
          done

      - name: Test workflows
        run: |
          # Test workflow syntax
          WORKFLOW_FILES=$(find .github/workflows -name "*.yml" -o -name "*.yaml")
          for file in $WORKFLOW_FILES; do
            echo "Testing workflow syntax: $file"
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"workflow\": $(cat $file | jq -Rs .)}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/test || true
          done

      - name: Commit and push fixes
        run: |
          # Check if there are any changes
          if git status --porcelain | grep -q .; then
            git add .
            git commit -m "Automated fixes for repository issues"
            git push origin ${{ matrix.branch }}
            echo "Pushed fixes to branch: ${{ matrix.branch }}"
          else
            echo "No changes to commit for branch: ${{ matrix.branch }}"
          fi

  create-summary:
    needs: fix-repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create fix summary
        run: |
          echo "# Repository Fix Summary" > fix-summary.md
          echo "\n## Fixes Performed" >> fix-summary.md
          echo "- Fixed workflow files syntax and structure"
          echo "- Fixed code file errors"
          echo "- Checked for broken references"
          echo "- Tested workflow syntax"
          echo "\n## Branches Processed"
          echo "${{ needs.discover-branches.outputs.branches }}"

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: fix-summary
          path: fix-summary.md

  notify-results:
    needs: create-summary
    runs-on: ubuntu-latest
    steps:
      - name: Download summary
        uses: actions/download-artifact@v4
        with:
          name: fix-summary

      - name: Notify results
        run: |
          echo "Repository fix process completed!"
          echo "Summary has been uploaded as an artifact."
          cat fix-summary.md

      - name: Send notification (optional)
        if: github.event_name == 'schedule'
        run: |
          # Add your notification logic here
          # For example, send a Slack message or email
          echo "Notification would be sent here in a production environment"\n
