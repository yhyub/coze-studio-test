name: Run All Workflows
# This workflow runs all other workflows in the repository with a single click
# It uses GitHub API to trigger workflow_dispatch events for all workflows

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflows on'
        required: true
        default: 'main'
      dry-run:
        description: 'Dry run (just list workflows, don''t run them)'
        required: false
        default: 'false'

permissions:
  actions: write
  contents: read

jobs:
  run-all-workflows:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List all workflow files
        id: list-workflows
        run: |
          workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | grep -v "run-all-workflows.yml" | sort)
          echo "workflow_files=$workflow_files" >> $GITHUB_OUTPUT

      - name: Get workflow names
        id: get-workflow-names
        run: |
          workflow_files=${{ steps.list-workflows.outputs.workflow_files }}
          workflow_names=$(echo "$workflow_files" | while read -r file; do
            name=$(grep -m 1 "name:" "$file" | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')
            echo "$name"
          done)
          echo "workflow_names=$workflow_names" >> $GITHUB_OUTPUT

      - name: Display workflows to run
        run: |
          echo "## Workflows to run"
          echo "${{ steps.list-workflows.outputs.workflow_files }}"
          echo ""
          echo "## Workflow names"
          echo "${{ steps.get-workflow-names.outputs.workflow_names }}"

      - name: Run all workflows
        if: ${{ github.event.inputs.dry-run == 'false' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branch = '${{ github.event.inputs.branch }}';
            
            // List of workflows to run (exclude this workflow)
            const workflowsToRun = [
              'all-in-one-fixer.yml',
              'all-in-one-workflow.yml',
              'ci.yml',
              'ci-backend.yml',
              'ci-main.yml',
              'claude.yml',
              'common-pr-checks.yml',
              'complete-ci-cd.yml',
              'deno.yml',
              'deploy.yml',
              'enhanced-workflow-fixer.yml',
              'idl.yaml',
              'license-check.yaml',
              'marketplace-install.yml',
              'marketplace-manager.yml',
              'marketplace-submit.yml',
              'release.yml',
              'security-scan.yml',
              'semantic-pull-request.yaml',
              'workflow-fixer.yml',
              'workflow-fixer-global.yml',
              'workflow-fixer-unified.yml',
              'workflow-unified.yml',
              'workflow-validator.yml'
            ];
            
            console.log(`Running ${workflowsToRun.length} workflows on branch ${branch}...`);
            
            // For each workflow, get its ID and trigger it
            for (const workflowFile of workflowsToRun) {
              try {
                // Get workflow ID by filename
                const workflows = await github.rest.actions.listRepoWorkflows({
                  owner,
                  repo
                });
                
                const workflow = workflows.data.workflows.find(w => w.path === `.github/workflows/${workflowFile}`);
                
                if (workflow) {
                  console.log(`Triggering workflow: ${workflow.name} (${workflow.id})`);
                  
                  // Trigger the workflow
                  await github.rest.actions.createWorkflowDispatch({
                    owner,
                    repo,
                    workflow_id: workflow.id,
                    ref: branch,
                    inputs: {}
                  });
                  
                  console.log(`Successfully triggered ${workflow.name}`);
                  
                  // Add a delay to avoid rate limiting
                  await new Promise(resolve => setTimeout(resolve, 2000));
                } else {
                  console.log(`Workflow not found: ${workflowFile}`);
                }
              } catch (error) {
                console.error(`Error triggering workflow ${workflowFile}:`, error.message);
              }
            }
            
            console.log('All workflows have been triggered!');

      - name: Summary
        run: |
          echo "## Summary"
          echo "- Branch: ${{ github.event.inputs.branch }}"
          echo "- Dry run: ${{ github.event.inputs.dry-run }}"
          echo "- Workflows to run: ${{ steps.list-workflows.outputs.workflow_files }}"
          if [ "${{ github.event.inputs.dry-run }}" == "false" ]; then
            echo "- All workflows have been triggered successfully!"
          else
            echo "- Dry run completed, no workflows were triggered."
          fi

      - name: Send notification
        if: ${{ failure() }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
