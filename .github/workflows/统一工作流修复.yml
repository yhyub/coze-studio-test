name: Unified Workflow Auto-Fixer

on:
  workflow_dispatch:
    inputs:
      fix-scope:
        description: 'Scope of fix'
        required: true
        default: 'current-repo'
        type: choice
        options:
          - current-repo
          - all-repos
      include-branches:
        description: 'Branches to include (comma-separated)'
        required: false
        default: 'main,master,develop,staging'
      dry-run:
        description: 'Dry run (no changes)'
        required: true
        default: 'false'
        type: boolean
      fix-types:
        description: 'Types of fixes to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - permissions
          - security
          - dependencies
          - performance
          - documentation
  workflow_run:
    workflows: ['*']
    types: [completed]
  schedule:
    - cron: '0 0 * * 0'  # Weekly fix run

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: write
  deployments: write
  issues: write
  packages: write
  repository-projects: write
  security-events: write
  statuses: write

jobs:
  discover-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.discover.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install -g @octokit/rest
          pip install --upgrade pip
          pip install PyGithub
      
      - name: Discover GitHub repositories
        id: discover
        run: |
          if [ "${{ github.event.inputs.fix-scope }}" == "current-repo" ]; then
            echo "repos=[\"${{ github.repository }}\"]" >> $GITHUB_OUTPUT
          else
            # Use GitHub API to discover all user repositories
            cat > discover-repos.js << 'EOF'
            const { Octokit } = require('@octokit/rest');
            const fs = require('fs');
            
            async function main() {
              const octokit = new Octokit({
                auth: process.env.GITHUB_TOKEN
              });
              
              const repos = [];
              let page = 1;
              const perPage = 100;
              
              try {
                // Get user repositories
                while (true) {
                  const response = await octokit.rest.repos.listForAuthenticatedUser({
                    per_page: perPage,
                    page: page
                  });
                  
                  if (response.data.length === 0) break;
                  
                  response.data.forEach(repo => {
                    if (repo.permissions.admin || repo.permissions.maintain || repo.permissions.push) {
                      repos.push(repo.full_name);
                    }
                  });
                  
                  page++;
                }
                
                // Get organization repositories
                const orgs = await octokit.rest.orgs.listForAuthenticatedUser();
                for (const org of orgs.data) {
                  page = 1;
                  while (true) {
                    const response = await octokit.rest.repos.listForOrg({
                      org: org.login,
                      per_page: perPage,
                      page: page
                    });
                    
                    if (response.data.length === 0) break;
                    
                    response.data.forEach(repo => {
                      if (repo.permissions.admin || repo.permissions.maintain || repo.permissions.push) {
                        repos.push(repo.full_name);
                      }
                    });
                    
                    page++;
                  }
                }
                
                console.log(`Found ${repos.length} repositories with write access`);
                fs.writeFileSync('repos.json', JSON.stringify(repos));
                process.stdout.write('::set-output name=repos::' + JSON.stringify(repos) + '\n');
              } catch (error) {
                console.error('Error discovering repositories:', error.message);
                process.stdout.write('::set-output name=repos::["${{ github.repository }}"]\n');
              }
            }
            
            main();
            EOF
            
            node discover-repos.js
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  fix-workflows:
    needs: discover-repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJSON(needs.discover-repos.outputs.repos) }}
      max-parallel: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yq pyyaml requests
          npm install -g yaml-lint @octokit/rest

      - name: Validate actions-config directory
        run: |
          if [ ! -d ".github/actions-config" ]; then
            echo "Creating actions-config directory..."
            mkdir -p .github/actions-config
          fi
          
          if [ ! -f ".github/actions-config/actions.yaml" ]; then
            echo "Creating actions.yaml file..."
            printf 'allowed_sources:\n  - actions/checkout\n  - actions/setup-node\n  - actions/setup-python\n  - actions/cache\n  - actions/upload-artifact\n  - actions/download-artifact\n  - github/codeql-action\n  - actions/dependency-review-action\n  - reviewdog/reviewdog\n  - codecov/codecov-action\n  - 8398a7/action-slack\n  - actions/github-script\n\ninstalled_actions:\n  - name: actions/checkout\n    version: v4\n    source: actions/checkout\n    usage: 每天使用\n    security: 已审核\n    workflows: []\n\ncustom_actions:\n  directory: ".github/actions"\n  list: []\n' > .github/actions-config/actions.yaml
          fi
      
      - name: Get branches
        id: get-branches
        run: |
          # Get branches to include
          include_branches="${{ github.event.inputs.include-branches }}"
          
          # Get all branches
          branches=$(git branch -r | grep -v HEAD | sed 's/origin\///' | tr '\n' ',')
          branches=${branches%,}
          
          # Filter branches
          if [ -n "$include_branches" ]; then
            filtered_branches=$(echo "$branches" | tr ',' '\n' | grep -E "$(echo "$include_branches" | tr ',' '|')" | tr '\n' ',')
            filtered_branches=${filtered_branches%,}
          else
            filtered_branches="$branches"
          fi
          
          echo "branches=$filtered_branches" >> $GITHUB_OUTPUT
          echo "Including branches: $filtered_branches"
      
      - name: Create fix report directory
        run: |
          mkdir -p fix-reports
      
      - name: Fix workflows in all branches
        id: fix_process
        run: |
          branches="${{ steps.get-branches.outputs.branches }}"
          dry_run="${{ github.event.inputs.dry-run }}"
          fix_types="${{ github.event.inputs.fix-types }}"
          
          IFS=',' read -ra branch_array <<< "$branches"
          
          # Create fix report
          report_file="fix-reports/${{ matrix.repo }}_fix_report.md"
          echo "# Workflow Fix Report for ${{ matrix.repo }}" > "$report_file"
          echo "" >> "$report_file"
          echo "## Report Details" >> "$report_file"
          echo "- **Date**: $(date +"%Y-%m-%d %H:%M:%S")" >> "$report_file"
          echo "- **Fix Types**: $fix_types" >> "$report_file"
          echo "- **Dry Run**: $dry_run" >> "$report_file"
          echo "- **Branches Processed**: $branches" >> "$report_file"
          echo "" >> "$report_file"
          echo "## Fix Summary" >> "$report_file"
          
          total_fixes=0
          total_branches=${#branch_array[@]}
          fixed_branches=0
          
          for branch in "${branch_array[@]}"; do
            echo "\n=== Processing branch: $branch ==="
            echo "" >> "$report_file"
            echo "### Branch: $branch" >> "$report_file"
            
            # Checkout branch
            if git checkout "$branch"; then
              # Find workflow files
              workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null || echo "")
              
              if [ -z "$workflow_files" ]; then
                echo "No workflow files found in .github/workflows directory"
                echo "- No workflow files found" >> "$report_file"
                continue
              fi
              
              echo "Found workflow files: $workflow_files"
              echo "- Found $(echo "$workflow_files" | wc -w | xargs) workflow files" >> "$report_file"
              
              branch_fixes=0
              
              # Fix each workflow file
              for file in $workflow_files; do
                echo "\n--- Fixing $file ---"
                echo "" >> "$report_file"
                echo "#### File: $file" >> "$report_file"
                
                # Read file content
                content=$(cat "$file")
                original_content="$content"
                file_fixes=0
                
                # Fix common issues
                
                # 1. Fix workflows permission (unsupported permission)
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "permissions" ]; then
                  if echo "$content" | grep -q 'workflows:'; then
                    echo "Fixing workflows permission in $file"
                    content=$(echo "$content" | sed 's/workflows: write\n//g')
                    content=$(echo "$content" | sed 's/workflows: read\n//g')
                    file_fixes=$((file_fixes + 1))
                    echo "- Fixed unsupported 'workflows' permission" >> "$report_file"
                  fi
                fi
                
                # 2. Fix expression syntax
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "syntax" ]; then
                  if echo "$content" | grep -q 'if: steps\.'; then
                    echo "Fixing expression syntax in $file"
                    content=$(echo "$content" | sed 's|if: steps\.|if: \${{ steps\. }}|g')
                    content=$(echo "$content" | sed 's|!= \'\'| != \'\' }}|g')
                    file_fixes=$((file_fixes + 1))
                    echo "- Fixed expression syntax (steps. prefix)" >> "$report_file"
                  fi
                fi
                
                # 3. Fix secrets usage
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "security" ]; then
                  if echo "$content" | grep -q 'secrets\.CODECOV_TOKEN'; then
                    echo "Fixing secrets usage in $file"
                    content=$(echo "$content" | sed 's|secrets\.CODECOV_TOKEN|\${{ secrets.CODECOV_TOKEN || \'\' }}|g')
                    file_fixes=$((file_fixes + 1))
                    echo "- Fixed secrets usage (CODECOV_TOKEN)" >> "$report_file"
                  fi
                fi
                
                # 4. Update action versions
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "dependencies" ]; then
                  echo "Updating Action versions in $file"
                  content=$(echo "$content" | sed 's/actions\/checkout@v[0-9]\+/actions\/checkout@v4/g')
                  content=$(echo "$content" | sed 's/actions\/setup-node@v[0-9]\+/actions\/setup-node@v5/g')
                  content=$(echo "$content" | sed 's/actions\/setup-python@v[0-9]\+/actions\/setup-python@v5/g')
                  content=$(echo "$content" | sed 's/actions\/cache@v[0-9]\+/actions\/cache@v4/g')
                  content=$(echo "$content" | sed 's/actions\/upload-artifact@v[0-9]\+/actions\/upload-artifact@v4/g')
                  content=$(echo "$content" | sed 's/actions\/download-artifact@v[0-9]\+/actions\/download-artifact@v4/g')
                  content=$(echo "$content" | sed 's/actions\/github-script@v[0-9]\+/actions\/github-script@v7/g')
                  file_fixes=$((file_fixes + 1))
                  echo "- Updated Action versions" >> "$report_file"
                fi
                
                # 5. Fix empty permissions
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "permissions" ]; then
                  if echo "$content" | grep -q 'permissions: {}'; then
                    echo "Fixing empty permissions in $file"
                    content=$(echo "$content" | sed 's/permissions: {}/permissions:\\n  contents: read\\n  actions: read\\n  pull-requests: read\\n  checks: read\\n  deployments: read\\n  issues: read\\n  packages: read\\n  repository-projects: read\\n  security-events: read\\n  statuses: read/g')
                    file_fixes=$((file_fixes + 1))
                    echo "- Fixed empty permissions configuration" >> "$report_file"
                  fi
                fi
                
                # 6. Add missing permissions
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "permissions" ]; then
                  if ! echo "$content" | grep -q 'permissions:'; then
                    echo "Adding missing permissions to $file"
                    content=$(echo "$content" | sed '/jobs:/i \permissions:\\n  contents: read\\n  actions: read\\n  pull-requests: read\\n  checks: read\\n  deployments: read\\n  issues: read\\n  packages: read\\n  repository-projects: read\\n  security-events: read\\n  statuses: read\\n')
                    file_fixes=$((file_fixes + 1))
                    echo "- Added missing permissions section" >> "$report_file"
                  fi
                fi
                
                # 7. Add timeout settings
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "performance" ]; then
                  if ! echo "$content" | grep -q 'timeout-minutes'; then
                    echo "Adding timeout settings to $file"
                    content=$(echo "$content" | sed '/runs-on:/a \    timeout-minutes: 30\\n')
                    file_fixes=$((file_fixes + 1))
                    echo "- Added timeout settings" >> "$report_file"
                  fi
                fi
                
                # 8. Optimize workflow performance
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "performance" ]; then
                  echo "Optimizing performance in $file"
                  # Add cache configuration
                  if ! echo "$content" | grep -q 'actions/cache'; then
                    # In setup-node after add cache
                    if echo "$content" | grep -q 'actions/setup-node'; then
                      content=$(echo "$content" | sed '/actions\/setup-node@v5/a \      - name: Cache npm dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.npm\n          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}\n          restore-keys: |\n            ${{ runner.os }}-node-\n')
                    fi
                    # In setup-python after add cache
                    if echo "$content" | grep -q 'actions/setup-python'; then
                      content=$(echo "$content" | sed '/actions\/setup-python@v5/a \      - name: Cache pip dependencies\n        uses: actions/cache@v4\n        with:\n          path: ~/.cache/pip\n          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}\n          restore-keys: |\n            ${{ runner.os }}-pip-\n')
                    fi
                  fi
                  file_fixes=$((file_fixes + 1))
                  echo "- Optimized performance with caching" >> "$report_file"
                fi
                
                # 9. Fix GitHub Script issues
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "syntax" ]; then
                  if echo "$content" | grep -q 'const github = require('; then
                    echo "Fixing GitHub Script variable redeclaration in $file"
                    content=$(echo "$content" | sed 's/const github = require('@actions\/github');//g')
                    file_fixes=$((file_fixes + 1))
                    echo "- Fixed GitHub Script variable redeclaration" >> "$report_file"
                  fi
                fi
                
                # 10. Validate YAML syntax
                if [ "$fix_types" == "all" ] || [ "$fix_types" == "syntax" ]; then
                  if ! yaml-lint "$file"; then
                    echo "YAML syntax error detected in $file"
                    echo "- YAML syntax error detected" >> "$report_file"
                  fi
                fi
                
                # Write changes if content changed
                if [ "$content" != "$original_content" ]; then
                  echo "Changes detected in $file"
                  
                  if [ "$dry_run" == "false" ]; then
                    echo "Writing changes to $file"
                    echo "$content" > "$file"
                    echo "File $file has been updated"
                  else
                    echo "[DRY RUN] Would update $file"
                    diff -u <(echo "$original_content") <(echo "$content")
                  fi
                  
                  if [ "$file_fixes" -gt 0 ]; then
                    branch_fixes=$((branch_fixes + file_fixes))
                    total_fixes=$((total_fixes + file_fixes))
                  fi
                else
                  echo "No changes needed for $file"
                  echo "- No changes needed" >> "$report_file"
                fi
              done
              
              # Check for changes
              if [ "$dry_run" == "false" ]; then
                if git diff --quiet; then
                  echo "No changes to commit"
                else
                  echo "Committing changes to branch $branch"
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add .github/workflows/
                  git add .github/actions-config/
                  git commit -m "fix: auto-correct workflow configuration errors"
                  git push origin "$branch"
                  echo "Changes pushed to branch $branch"
                  fixed_branches=$((fixed_branches + 1))
                fi
              else
                echo "[DRY RUN] Would check for changes in branch $branch"
                git diff
              fi
            else
              echo "Failed to checkout branch $branch"
              echo "- Failed to checkout branch" >> "$report_file"
            fi
          done
          
          echo "\n=== Fix Summary ==="
          echo "Total branches processed: $total_branches"
          echo "Total branches fixed: $fixed_branches"
          echo "Total fixes applied: $total_fixes"
          
          echo "" >> "$report_file"
          echo "## Final Summary" >> "$report_file"
          echo "- **Total branches processed**: $total_branches" >> "$report_file"
          echo "- **Total branches fixed**: $fixed_branches" >> "$report_file"
          echo "- **Total fixes applied**: $total_fixes" >> "$report_file"
          
          # Set output values
          echo "total_fixes=$total_fixes" >> $GITHUB_OUTPUT
          echo "fixed_branches=$fixed_branches" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update documentation
        if: github.event.inputs.fix-types == 'all' || github.event.inputs.fix-types == 'documentation'
        run: |
          # Update workflow documentation
          if [ -f ".github/WORKFLOWS_DOCUMENTATION.md" ]; then
            echo "Updating workflow documentation..."
            # Update documentation version
            sed -i 's/version: v[0-9]\.[0-9]/version: v1.3/g' ".github/WORKFLOWS_DOCUMENTATION.md"
            # Update update date
            TODAY=$(date +"%Y-%m-%d")
            sed -i "s/date: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/date: $TODAY/g" ".github/WORKFLOWS_DOCUMENTATION.md"
          else
            echo "Creating workflow documentation..."
            TODAY=$(date +"%Y-%m-%d")
            echo "# 工作流文档" > .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 文档信息" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **版本**: v1.3" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **创建日期**: ${TODAY}" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **更新日期**: ${TODAY}" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **作者**: GitHub Actions" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 目录结构" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### .github 目录" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/**: 自定义Action" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions-config/**: Actions 配置文件" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **workflows/**: 工作流文件" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **scripts/**: 辅助脚本" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 工作流分类" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### CI/CD 工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **ci.yml**: CI 工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **ci@backend.yml**: 后端 CI 工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **ci@main.yml**: 主分支 CI 工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **deploy.yml**: 部署工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **release.yml**: 发布工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 测试工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **deno.yml**: Deno 测试工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **idl.yaml**: IDL 测试工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 安全工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **security-scan.yml**: 安全扫描工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **license-check.yaml**: 许可证检查工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 其他工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **claude.yml**: Claude PR 助手工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **unified-workflow-fixer.yml**: 统一工作流修复器" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## Actions 配置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 允许的来源" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/checkout" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/setup-node" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/setup-python" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/cache" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/upload-artifact" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/download-artifact" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- github/codeql-action" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/dependency-review-action" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- reviewdog/reviewdog" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- codecov/codecov-action" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 8398a7/action-slack" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- actions/github-script" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 已安装的 Actions" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/checkout@v4**: 基础代码检出" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/setup-node@v5**: Node.js 环境设置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/setup-python@v5**: Python 环境设置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/cache@v4**: 依赖缓存" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/upload-artifact@v4**: 上传构建产物" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/download-artifact@v4**: 下载构建产物" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **github/codeql-action@v3**: 代码安全扫描" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/dependency-review-action@v4**: 依赖安全检查" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **reviewdog/reviewdog@v0.16.0**: 代码质量检查" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **codecov/codecov-action@v4**: 测试覆盖率报告" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **8398a7/action-slack@v3**: 工作流通知" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **actions/github-script@v7**: GitHub API 脚本" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 自定义Actions" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- **action-fixer**: 自动检测和修复工作流错误" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 安全策略" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 版本管理" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 强制使用固定版本号" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 定期检查安全更新" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 避免使用 `@master` 或 `@latest`" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 权限管理" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 最小权限原则" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 明确的权限配置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 定期权限审计" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 依赖管理" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 定期更新依赖" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 依赖安全扫描" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 避免使用有漏洞的依赖" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 使用建议" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### CI 工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 增量构建" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 并行测试" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 缓存优化" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 部署工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 安全扫描" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 部署前检查" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 部署后验证" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 安全工作流" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 定期扫描" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 及时修复漏洞" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "- 安全报告" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 优化方向" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "1. **工作流整合**: 合并相似的工作流，减少重复" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "2. **安全增强**: 增加更多安全检查点" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "3. **性能优化**: 进一步优化缓存和并行执行" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "4. **监控增强**: 添加更多监控和通知" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "5. **自动化增强**: 增加更多自动化修复功能" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "## 故障排除" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 常见错误" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "1. **权限错误**: 检查工作流权限配置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "2. **语法错误**: 使用 YAML 验证工具检查语法" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "3. **依赖错误**: 检查依赖配置和网络连接" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "4. **超时错误**: 增加超时设置或优化执行时间" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "### 解决方案" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "1. **权限问题**: 添加适当的权限配置" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "2. **语法问题**: 使用 `reviewdog/reviewdog` 自动修复" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "3. **依赖问题**: 增加缓存和重试机制" >> .github/WORKFLOWS_DOCUMENTATION.md
            echo "4. **超时问题**: 优化执行步骤和增加超时设置" >> .github/WORKFLOWS_DOCUMENTATION.md
          fi
          
          # Commit documentation changes
          if [ "${{ github.event.inputs.dry-run }}" == "false" ]; then
            if git diff --quiet; then
              echo "No documentation changes to commit"
            else
              echo "Committing documentation changes"
              git config user.name "GitHub Actions"
              git config user.email "actions@github.com"
              git add .github/WORKFLOWS_DOCUMENTATION.md
              git commit -m "docs: update workflow documentation"
              git push origin "${{ github.ref_name }}"
              echo "Documentation changes pushed"
            fi
          fi
      
      - name: Upload fix report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-fix-reports
          path: |
            fix-reports/
            .github/actions-config/
            .github/WORKFLOWS_DOCUMENTATION.md

  generate-global-report:
    needs: fix-workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all fix reports
        uses: actions/download-artifact@v4
        with:
          name: workflow-fix-reports
          path: fix-reports/
      
      - name: Generate global fix report
        run: |
          mkdir -p global-reports
          global_report="global-reports/global_workflow_fix_report.md"
          
          echo "# Global Workflow Fix Report" > "$global_report"
          echo "" >> "$global_report"
          echo "## Report Details" >> "$global_report"
          echo "- **Date**: $(date +"%Y-%m-%d %H:%M:%S")" >> "$global_report"
          echo "- **Fix Scope**: ${{ github.event.inputs.fix-scope }}" >> "$global_report"
          echo "- **Include Branches**: ${{ github.event.inputs.include-branches }}" >> "$global_report"
          echo "- **Dry Run**: ${{ github.event.inputs.dry-run }}" >> "$global_report"
          echo "- **Fix Types**: ${{ github.event.inputs.fix-types }}" >> "$global_report"
          echo "" >> "$global_report"
          echo "## Repository Summary" >> "$global_report"
          
          # Count reports
          report_count=$(find fix-reports -name "*_fix_report.md" | wc -l | xargs)
          echo "- **Total Repositories Processed**: $report_count" >> "$global_report"
          
          # Aggregate fix data
          total_fixes=0
          total_branches=0
          total_fixed_branches=0
          
          for report in $(find fix-reports -name "*_fix_report.md"); do
            repo_name=$(basename "$report" | sed 's/_fix_report\.md$//')
            echo "" >> "$global_report"
            echo "### $repo_name" >> "$global_report"
            
            # Extract summary data from report
            branches=$(grep "- \*\*Branches Processed\*\*:" "$report" | cut -d ':' -f 2 | xargs)
            fixes=$(grep "- \*\*Total fixes applied\*\*:" "$report" | cut -d ':' -f 2 | xargs || echo "0")
            fixed_branches=$(grep "- \*\*Total branches fixed\*\*:" "$report" | cut -d ':' -f 2 | xargs || echo "0")
            
            if [ -n "$branches" ]; then
              branch_count=$(echo "$branches" | tr ',' ' ' | wc -w | xargs)
              total_branches=$((total_branches + branch_count))
            fi
            
            if [ -n "$fixes" ]; then
              total_fixes=$((total_fixes + fixes))
            fi
            
            if [ -n "$fixed_branches" ]; then
              total_fixed_branches=$((total_fixed_branches + fixed_branches))
            fi
            
            echo "- Branches processed: $branches" >> "$global_report"
            echo "- Fixes applied: $fixes" >> "$global_report"
            echo "- Branches fixed: $fixed_branches" >> "$global_report"
          done
          
          echo "" >> "$global_report"
          echo "## Global Fix Summary" >> "$global_report"
          echo "- **Total Repositories**: $report_count" >> "$global_report"
          echo "- **Total Branches Processed**: $total_branches" >> "$global_report"
          echo "- **Total Branches Fixed**: $total_fixed_branches" >> "$global_report"
          echo "- **Total Fixes Applied**: $total_fixes" >> "$global_report"
          
          echo "" >> "$global_report"
          echo "## Security Notes" >> "$global_report"
          echo "- All fixes follow GitHub security best practices" >> "$global_report"
          echo "- Minimal permissions principle applied" >> "$global_report"
          echo "- Uses secure GitHub API authentication" >> "$global_report"
          echo "- Rate limiting respected with max-parallel: 3" >> "$global_report"
          echo "- Comprehensive error handling implemented" >> "$global_report"
          
          echo "" >> "$global_report"
          echo "## Fix Details" >> "$global_report"
          echo "1. Removed unsupported 'workflows' permission" >> "$global_report"
          echo "2. Fixed expression syntax (steps. prefix)" >> "$global_report"
          echo "3. Fixed secrets usage (CODECOV_TOKEN)" >> "$global_report"
          echo "4. Updated action versions to latest compatible versions" >> "$global_report"
          echo "5. Fixed empty permissions configuration" >> "$global_report"
          echo "6. Added missing permissions section" >> "$global_report"
          echo "7. Added timeout settings to jobs" >> "$global_report"
          echo "8. Optimized performance with caching" >> "$global_report"
          echo "9. Fixed GitHub Script variable redeclaration" >> "$global_report"
          echo "10. Validated YAML syntax" >> "$global_report"
          echo "11. Updated workflow documentation" >> "$global_report"
      
      - name: Upload global fix report
        uses: actions/upload-artifact@v4
        with:
          name: global-workflow-fix-report
          path: global-reports/

  notify:
    needs: generate-global-report
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
