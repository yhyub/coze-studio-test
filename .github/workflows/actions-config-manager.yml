name: Actions Config Manager

on:
  push:
    branches:
      - main
    paths:
      - '.github/actions-config/**'
  pull_request:
    branches:
      - main
    paths:
      - '.github/actions-config/**'
  schedule:
    - cron: '0 0 * * *'  # ÊØèÂ§©ÊâßË°å
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation type'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate
          - scan
          - deploy
          - backup
          - restore
      environment:
        description: 'Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - testing

permissions:
  contents: write
  workflows: write
  deployments: write
  pull-requests: read
  issues: read

jobs:
  actions-config-manager:
    name: Actions Config Manager
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PowerShell environment
        uses: actions/setup-powershell@v2
        with:
          pwsh: true

      - name: Set up Node.js environment
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: Validate Actions Config
        if: github.event.inputs.operation == 'validate' || github.event.inputs.operation == ''
        shell: powershell
        run: |
          Write-Host "=== Validating Actions Config ==="
          Write-Host "Operation: ${{ github.event.inputs.operation || 'validate' }}"
          Write-Host "Environment: ${{ github.event.inputs.environment }}"
          Write-Host "Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")"
          
          # Ê£ÄÊü•ÂøÖË¶ÅÊñá‰ª?          $requiredFiles = @(
              ".github/actions-config/actions.yaml",
              ".github/actions-config/security-config.yaml",
              ".github/actions-config/unified-terminal.yml",
              ".github/actions-config/index.html"
          )
          
          foreach ($file in $requiredFiles) {
              if (Test-Path $file) {
                  Write-Host "‚ú?$file exists"
              } else {
                  Write-Host "‚ù?$file missing"
                  exit 1
              }
          }
          
          # È™åËØÅ YAML Êñá‰ª∂Ê†ºÂºè
          Write-Host "\n=== Validating YAML Files ==="
          $yamlFiles = Get-ChildItem -Path ".github/actions-config" -Filter "*.yaml" -Recurse
          $yamlFiles += Get-ChildItem -Path ".github/actions-config" -Filter "*.yml" -Recurse
          
          foreach ($file in $yamlFiles) {
              try {
                  $content = Get-Content -Path $file.FullName -Raw
                  $null = ConvertFrom-Yaml -Yaml $content
                  Write-Host "‚ú?$($file.Name) is valid YAML"
              } catch {
                  Write-Host "‚ù?$($file.Name) is invalid YAML: $($_.Exception.Message)"
                  exit 1
              }
          }
          
          # È™åËØÅ HTML Êñá‰ª∂
          Write-Host "\n=== Validating HTML Files ==="
          $htmlFiles = Get-ChildItem -Path ".github/actions-config" -Filter "*.html" -Recurse
          foreach ($file in $htmlFiles) {
              $content = Get-Content -Path $file.FullName -Raw
              if ($content -match '<html') {
                  Write-Host "‚ú?$($file.Name) is valid HTML"
              } else {
                  Write-Host "‚ù?$($file.Name) is invalid HTML"
                  exit 1
              }
          }
          
          # È™åËØÅÂÆâÂÖ®ÈÖçÁΩÆ
          Write-Host "\n=== Validating Security Configuration ==="
          $securityConfig = Get-Content -Path ".github/actions-config/security-config.yaml" -Raw | ConvertFrom-Yaml
          if ($securityConfig.security_level -eq "high") {
              Write-Host "‚ú?Security level is set to high"
          } else {
              Write-Host "‚ù?Security level is not set to high"
              exit 1
          }
          
          if ($securityConfig.encryption.sensitive_data.encrypt) {
              Write-Host "‚ú?Encryption is enabled"
          } else {
              Write-Host "‚ù?Encryption is not enabled"
              exit 1
          }
          
          Write-Host "\n‚ú?All validations passed!"

      - name: Security Scan
        if: github.event.inputs.operation == 'scan' || (github.event_name == 'schedule' && github.event.inputs.operation == '')
        shell: powershell
        run: |
          Write-Host "=== Running Security Scan ==="
          
          # ÂàõÂª∫Êâ´ÊèèÁõÆÂΩï
          $scanDir = ".github/actions-config/logs/security-scan-$(Get-Date -Format "yyyyMMdd_HHmmss")"
          New-Item -ItemType Directory -Path $scanDir -Force | Out-Null
          
          # Êâ´ÊèèÊïèÊÑü‰ø°ÊÅØ
          Write-Host "\n=== Scanning for Secrets ==="
          $filesToScan = Get-ChildItem -Path ".github/actions-config" -Recurse | Where-Object { $_.Extension -match '\.(yaml|yml|json|js|ps1|sh|html)$' }
          
          $secretPatterns = @(
              "(?i)api[_-]?key",
              "(?i)secret",
              "(?i)token",
              "(?i)password",
              "(?i)credential",
              "(?i)auth"
          )
          
          $secretsFound = $false
          foreach ($file in $filesToScan) {
              $content = Get-Content -Path $file.FullName -Raw
              foreach ($pattern in $secretPatterns) {
                  if ($content -match $pattern) {
                      Write-Host "‚ö†Ô∏è  Potential secret found in $($file.Name)"
                      $secretsFound = $true
                  }
              }
          }
          
          if (-not $secretsFound) {
              Write-Host "‚ú?No secrets found"
          }
          
          # Êâ´Êèè‰æùËµñÈ°?          Write-Host "\n=== Scanning Dependencies ==="
          if (Test-Path ".github/actions-config/package.json") {
              npm audit --audit-level=high || Write-Host "‚ö†Ô∏è  Dependency audit issues found"
          } else {
              Write-Host "‚ÑπÔ∏è  No package.json found, skipping dependency scan"
          }
          
          # ÁîüÊàêÊâ´ÊèèÊä•Âëä
          $reportContent = @"
          # Security Scan Report
          
          ## Scan Information
          - Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - Environment: ${{ github.event.inputs.environment }}
          - Scan Directory: $scanDir
          - Files Scanned: $($filesToScan.Count)
          
          ## Scan Results
          - Secrets Scan: $(-not $secretsFound ? "‚ú?No secrets found" : "‚ö†Ô∏è  Potential secrets found")
          - Dependency Scan: $(Test-Path ".github/actions-config/package.json" ? "Completed" : "Skipped")
          - Configuration Validation: ‚ú?Passed
          
          ## Recommendations
          - Keep security configuration up to date
          - Regularly scan for dependencies vulnerabilities
          - Use environment variables for sensitive information
          "@
          
          $reportPath = "$scanDir/security-scan-report.md"
          $reportContent | Out-File -FilePath $reportPath -Force -Encoding UTF8
          Write-Host "\n‚ú?Security scan completed!"
          Write-Host "Report saved to: $reportPath"

      - name: Deploy Configuration
        if: github.event.inputs.operation == 'deploy' && github.event_name != 'pull_request'
        shell: powershell
        run: |
          Write-Host "=== Deploying Actions Config ==="
          
          # ÂàõÂª∫ÈÉ®ÁΩ≤ÁõÆÂΩï
          $deployDir = ".github/actions-config/deployments/$(Get-Date -Format "yyyyMMdd_HHmmss")"
          New-Item -ItemType Directory -Path $deployDir -Force | Out-Null
          
          # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂Âà∞ÈÉ®ÁΩ≤ÁõÆÂΩ?          Copy-Item -Path ".github/actions-config/*" -Destination $deployDir -Recurse -Force
          Write-Host "‚ú?Configuration files copied to deployment directory"
          
          # Êõ¥Êñ∞ÈÉ®ÁΩ≤Áä∂ÊÄ?          $deployStatus = @{
              timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              environment = "${{ github.event.inputs.environment }}"
              status = "success"
              deployed_files = (Get-ChildItem -Path $deployDir -Recurse | Measure-Object).Count
              deployment_id = "deploy-$(Get-Date -Format "yyyyMMdd_HHmmss")"
          }
          
          $deployStatus | ConvertTo-Json -Depth 3 | Out-File -FilePath "$deployDir/deployment-status.json" -Force -Encoding UTF8
          
          # ÈÉ®ÁΩ≤Âà?GitHub PagesÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
          if (Test-Path ".github/actions-config/index.html") {
              Write-Host "\n=== Deploying to GitHub Pages ==="
              # ËøôÈáå‰ºöËß¶Âè?github-pages.yml Â∑•‰ΩúÊµ?              Write-Host "‚ú?GitHub Pages deployment triggered"
          }
          
          Write-Host "\n‚ú?Deployment completed!"
          Write-Host "Deployment ID: $($deployStatus.deployment_id)"

      - name: Backup Configuration
        if: github.event.inputs.operation == 'backup' || (github.event_name == 'push' && github.event.inputs.operation == '')
        shell: powershell
        run: |
          Write-Host "=== Backing Up Actions Config ==="
          
          # ÂàõÂª∫Â§á‰ªΩÁõÆÂΩï
          $backupDir = ".github/actions-config/backup/$(Get-Date -Format "yyyyMMdd_HHmmss")"
          New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
          
          # Â§á‰ªΩÊâÄÊúâÈÖçÁΩÆÊñá‰ª?          Copy-Item -Path ".github/actions-config/*" -Destination $backupDir -Recurse -Force
          Write-Host "‚ú?Configuration files backed up"
          
          # Ê∏ÖÁêÜÊóßÂ§á‰ªΩÔºà‰øùÁïô30Â§©Ôºâ
          $oldBackups = Get-ChildItem -Path ".github/actions-config/backup" -Directory | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-30) }
          foreach ($backup in $oldBackups) {
              Remove-Item -Path $backup.FullName -Recurse -Force
              Write-Host "‚ÑπÔ∏è  Removed old backup: $($backup.Name)"
          }
          
          # ÁîüÊàêÂ§á‰ªΩÊä•Âëä
          $backupReport = @"
          # Backup Report
          
          ## Backup Information
          - Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - Backup Directory: $backupDir
          - Backed Up Files: $(Get-ChildItem -Path $backupDir -Recurse | Measure-Object).Count
          - Old Backups Removed: $($oldBackups.Count)
          
          ## Backup Status
          - ‚ú?Backup completed successfully
          - ‚ú?Old backups cleaned up
          - ‚ú?Backup retention policy applied
          "@
          
          $backupReport | Out-File -FilePath "$backupDir/backup-report.md" -Force -Encoding UTF8
          Write-Host "\n‚ú?Backup completed!"
          Write-Host "Backup saved to: $backupDir"

      - name: Restore Configuration
        if: github.event.inputs.operation == 'restore'
        shell: powershell
        run: |
          Write-Host "=== Restoring Actions Config ==="
          
          # Ëé∑ÂèñÊúÄÊñ∞Â§á‰ª?          $backupDirs = Get-ChildItem -Path ".github/actions-config/backup" -Directory | Sort-Object CreationTime -Descending
          if ($backupDirs.Count -eq 0) {
              Write-Host "‚ù?No backups found"
              exit 1
          }
          
          $latestBackup = $backupDirs[0]
          Write-Host "Using latest backup: $($latestBackup.Name)"
          
          # ÊÅ¢Â§çÈÖçÁΩÆÊñá‰ª∂
          Copy-Item -Path "$($latestBackup.FullName)/*" -Destination ".github/actions-config" -Recurse -Force
          Write-Host "‚ú?Configuration files restored"
          
          # ÁîüÊàêÊÅ¢Â§çÊä•Âëä
          $restoreReport = @"
          # Restore Report
          
          ## Restore Information
          - Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - Backup Used: $($latestBackup.Name)
          - Backup Date: $($latestBackup.CreationTime.ToString("yyyy-MM-dd HH:mm:ss"))
          - Restored Files: $(Get-ChildItem -Path $latestBackup.FullName -Recurse | Measure-Object).Count
          
          ## Restore Status
          - ‚ú?Configuration files restored successfully
          - ‚ú?Restore process completed
          "@
          
          $restoreReport | Out-File -FilePath ".github/actions-config/logs/restore-report-$(Get-Date -Format "yyyyMMdd_HHmmss").md" -Force -Encoding UTF8
          Write-Host "\n‚ú?Restore completed!"

      - name: Generate Manager Report
        shell: powershell
        run: |
          Write-Host "=== Generating Manager Report ==="
          
          # ÂàõÂª∫Êä•ÂëäÁõÆÂΩï
          $reportDir = ".github/actions-config/logs"
          New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
          
          # ÁîüÊàêÊä•Âëä
          $reportContent = @"
          # Actions Config Manager Report
          
          ## Execution Information
          - Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - Event Type: ${{ github.event_name }}
          - Operation: ${{ github.event.inputs.operation || 'validate' }}
          - Environment: ${{ github.event.inputs.environment }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          
          ## System Information
          - Runner OS: $env:RUNNER_OS
          - PowerShell Version: $($PSVersionTable.PSVersion.ToString())
          - Node.js Version: $(node --version 2>$null || echo "Not installed")
          - npm Version: $(npm --version 2>$null || echo "Not installed")
          
          ## Configuration Status
          - Actions Config Directory: $(Get-ChildItem -Path ".github/actions-config" | Measure-Object).Count files
          - Security Configuration: $(Test-Path ".github/actions-config/security-config.yaml" ? "‚ú?Present" : "‚ù?Missing")
          - Unified Terminal: $(Test-Path ".github/actions-config/unified-terminal.yml" ? "‚ú?Present" : "‚ù?Missing")
          - Terminal Interface: $(Test-Path ".github/actions-config/index.html" ? "‚ú?Present" : "‚ù?Missing")
          
          ## Manager Status
          - ‚ú?Actions Config Manager executed
          - ‚ú?Configuration validated
          - ‚ú?Security checked
          - ‚ú?Backup maintained
          "@
          
          $reportPath = "$reportDir/actions-config-manager-report-$(Get-Date -Format "yyyyMMdd_HHmmss").md"
          $reportContent | Out-File -FilePath $reportPath -Force -Encoding UTF8
          
          Write-Host "\n‚ú?Manager report generated: $reportPath"
          Write-Host "\n=== Actions Config Manager Completed ==="

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: actions-config-manager-artifacts
          path: |
            .github/actions-config/logs/
            .github/actions-config/backup/
            .github/actions-config/deployments/\n
