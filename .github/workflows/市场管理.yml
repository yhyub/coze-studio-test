name: Marketplace Actions Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - validate
          - clean
          - audit

jobs:
  manage-marketplace-actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install yq

      - name: Validate actions-config directory
        run: |
          if [ ! -d ".github/actions-config" ]; then
            mkdir -p .github/actions-config
          fi
          
          if [ ! -f ".github/actions-config/actions.yaml" ]; then
            echo "Creating actions.yaml..."
            echo "allowed_sources: " > .github/actions-config/actions.yaml
            echo "  - actions/checkout" >> .github/actions-config/actions.yaml
            echo "  - actions/setup-node" >> .github/actions-config/actions.yaml
            echo "  - actions/setup-python" >> .github/actions-config/actions.yaml
            echo "  - actions/upload-artifact" >> .github/actions-config/actions.yaml
            echo "" >> .github/actions-config/actions.yaml
            echo "installed_actions: " >> .github/actions-config/actions.yaml
            echo "  - name: actions/checkout" >> .github/actions-config/actions.yaml
            echo "    version: v4" >> .github/actions-config/actions.yaml
            echo "    source: actions/checkout" >> .github/actions-config/actions.yaml
            echo "    usage: 基础代码检出" >> .github/actions-config/actions.yaml
            echo "    security: 已审核" >> .github/actions-config/actions.yaml
            echo "    workflows: []" >> .github/actions-config/actions.yaml
          fi
          
          echo "✓ Directory validated"

      - name: Sync marketplace actions
        if: github.event.inputs.action == 'sync'
        run: |
          cd .github/actions-config
          echo "Syncing..."
          if yq eval '.installed_actions' actions.yaml > /dev/null 2>&1; then
            echo "✓ Config valid"
          else
            echo "Error: Invalid config"
            exit 1
          fi

      - name: Validate workflow files
        if: github.event.inputs.action == 'validate'
        run: |
          echo "Validating workflows..."
          errors=""
          for file in .github/workflows/*.yml; do
            if ! yq eval "$file" > /dev/null 2>&1; then
              errors+="$file,"
            fi
          done
          errors=$(echo "$errors" | sed 's/,$//')
          if [ -n "$errors" ]; then
            echo "Error: Invalid files: $errors"
            exit 1
          else
            echo "✓ All valid"
          fi

      - name: Cleanup non-official files
        if: github.event.inputs.action == 'clean'
        run: |
          cd .github/actions-config
          echo "Cleaning..."
          official_files=('actions.yaml' 'install-action.sh' 'security-scan.sh' 'security-policy.md' 'marketplace-actions.yaml')
          for file in *; do
            is_official=false
            for official_file in "${official_files[@]}"; do
              if [ "$file" == "$official_file" ]; then
                is_official=true
                break
              fi
            done
            if [ -d "$file" ]; then
              if [ "$file" != "logs" ]; then
                echo "Removing directory: $file"
              fi
            elif [ "$is_official" == false ]; then
              echo "Removing file: $file"
            fi
          done

      - name: Audit marketplace actions
        if: github.event.inputs.action == 'audit'
        run: |
          cd .github/actions-config
          echo "Auditing..."
          if [ -f "security-scan.sh" ]; then
            CONFIG_FILE="actions.yaml" bash security-scan.sh -v -l
          else
            echo "security-scan.sh not found"
          fi

      - name: Upload audit results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-actions-audit
          path: .github/actions-config/logs/