#!/bin/bash\n\n# GitHub Action 安装脚本\n# 用于安全地安装和管理GitHub Actions\n\nset -e\n\n# 配置文件路径\nCONFIG_FILE="actions.yaml"\n\n# 显示帮助信息\nshow_help() {\n    echo "GitHub Action 安装脚本"\n    echo "用于安全地安装和管理GitHub Actions"\n    echo ""\n    echo "用法: ./install-action.sh [选项] <action-name> <version>"\n    echo ""\n    echo "选项:"\n    echo "  -h, --help          显示帮助信息"\n    echo "  -s, --source        指定Action来源（marketplace或github.com）"\n    echo "  -u, --usage         指定Action用途"\n    echo "  -w, --workflow      指定使用该Action的工作流文件"\n    echo "  -f, --force         强制安装，覆盖现有配置"\n    echo ""\n    echo "示例:"\n    echo "  ./install-action.sh -s marketplace -u '用于设置Rust开发环境' -w rust-ci.yml actions/setup-rust v3"\n    exit 0\n}\n\n# 解析命令行参数\nparse_args() {\n    while [[ $# -gt 0 ]]; do\n        case $1 in\n            -h|--help)\n                show_help\n                ;;\n            -s|--source)\n                SOURCE=$2\n                shift 2\n                ;;\n            -u|--usage)\n                USAGE=$2\n                shift 2\n                ;;\n            -w|--workflow)\n                WORKFLOW=$2\n                shift 2\n                ;;\n            -f|--force)\n                FORCE=true\n                shift 1\n                ;;\n            *)\n                if [[ -z $ACTION_NAME ]]; then\n                    ACTION_NAME=$1\n                elif [[ -z $VERSION ]]; then\n                    VERSION=$1\n                else\n                    echo "错误: 未知参数 '$1'"\n                    show_help\n                fi\n                shift 1\n                ;;\n        esac\n    done\n\n    # 检查必填参数\n    if [[ -z $ACTION_NAME || -z $VERSION ]]; then\n        echo "错误: 缺少必填参数"\n        show_help\n    fi\n\n    # 设置默认值\n    if [[ -z $SOURCE ]]; then\n        SOURCE="marketplace"\n    fi\n    if [[ -z $USAGE ]]; then\n        USAGE="未指定用途"\n    fi\n    if [[ -z $WORKFLOW ]]; then\n        WORKFLOW=""\n    fi\n    if [[ -z $FORCE ]]; then\n        FORCE=false\n    fi\n}\n\n# 检查Action是否已存在\ncheck_existing_action() {\n    local action_name=$1\n    if grep -q "name: $action_name" $CONFIG_FILE; then\n        echo "警告: Action '$action_name' 已存在"\n        if [[ $FORCE == false ]]; then\n            echo "使用 -f 或 --force 选项强制覆盖"\n            exit 1\n        else\n            echo "使用 -f 选项，将覆盖现有配置"\n        fi\n        return 0\n    else\n        return 1\n    fi\n}\n\n# 安装Action\ninstall_action() {\n    local action_name=$1\n    local version=$2\n    local source=$3\n    local usage=$4\n    local workflow=$5\n    local force=$6\n\n    # 检查Action是否已存在\n    if check_existing_action "$action_name"; then\n        # 如果Action已存在且使用了--force选项，先删除现有配置\n        if [[ $force == true ]]; then\n            # 使用sed删除现有Action配置\n            sed -i "/name: $action_name/,/^  - name:/d" $CONFIG_FILE\n            # 处理最后一个Action的情况\n            sed -i "/name: $action_name/,/^[^ ]/d" $CONFIG_FILE\n        fi\n    fi\n\n    # 构建工作流数组\n    local workflow_array\n    if [[ -n $workflow ]]; then\n        workflow_array="[$workflow]"\n    else\n        workflow_array="[]"\n    fi\n\n    # 添加新Action配置\n    cat >> $CONFIG_FILE << EOF\n  - name: $action_name\n    version: $version\n    source: $source\n    usage: $usage\n    security: 待审核\n    workflows: $workflow_array\n\nEOF\n\n    echo "Action '$action_name@$version' 已成功添加到配置文件中"\n    echo "请运行安全审核脚本: ./security-scan.sh"\n}\n\n# 主函数\nmain() {\n    parse_args "$@"\n    install_action "$ACTION_NAME" "$VERSION" "$SOURCE" "$USAGE" "$WORKFLOW" "$FORCE"\n}\n\n# 执行主函数\nmain "$@"\n