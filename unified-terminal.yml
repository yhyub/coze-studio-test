name: Unified Terminal Configuration

on:
  workflow_dispatch:
    inputs:
      terminal_type:
        description: 'Terminal type'
        required: true
        default: 'powershell'
        type: choice
        options:
          - powershell
          - nodejs
          - both
      test_type:
        description: 'Test type'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - advanced
          - security

jobs:
  unified-terminal-test:
    name: Unified Terminal Test
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js environment
        if: github.event.inputs.terminal_type == 'nodejs' || github.event.inputs.terminal_type == 'both'
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: PowerShell Terminal Test
        if: github.event.inputs.terminal_type == 'powershell' || github.event.inputs.terminal_type == 'both'
        shell: powershell
        run: |
          Write-Host "=== PowerShell Terminal Test ==="
          Write-Host "Terminal Type: ${{ github.event.inputs.terminal_type }}"
          Write-Host "Test Type: ${{ github.event.inputs.test_type }}"
          Write-Host "Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")"
          
          # 设置执行策略
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
          
          # 显示 PowerShell 版本
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion.ToString())"
          
          # 创建 PowerShell 配置文件
          $profileDir = Split-Path -Parent $PROFILE
          if (!(Test-Path $profileDir)) {
              New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
          }
          
          $profileContent = @"
          # Unified PowerShell Profile
          
          # 常用别名
          New-Alias -Name ll -Value Get-ChildItem
          New-Alias -Name ls -Value Get-ChildItem
          
          # 常用函数
          function Get-FileSize {
              param(
                  [string]$Path = "."
              )
              Get-ChildItem -Path $Path | Select-Object Name, Length, LastWriteTime
          }
          
          # 自定义提示符
          function prompt {
              "PS $($PWD.Path) > "
          }
          "@
          
          $profileContent | Out-File -FilePath $PROFILE -Force -Encoding UTF8
          . $PROFILE
          
          # 基本命令测试
          if ('${{ github.event.inputs.test_type }}' -eq 'basic' -or '${{ github.event.inputs.test_type }}' -eq 'advanced') {
              Write-Host "\n=== Basic PowerShell Commands ==="
              Get-ChildItem
              Get-Location
              New-Item -ItemType Directory -Path "test-dir" -Force
              "Hello from PowerShell!" | Out-File -FilePath "test-dir\test.txt" -Force
              Get-Content -Path "test-dir\test.txt"
              Remove-Item -Path "test-dir" -Recurse -Force
              Write-Host "✓ PowerShell basic commands executed successfully"
          }
          
          # 高级命令测试
          if ('${{ github.event.inputs.test_type }}' -eq 'advanced') {
              Write-Host "\n=== Advanced PowerShell Commands ==="
              Get-ChildItem | Where-Object {$_.Extension -eq ".yml" -or $_.Extension -eq ".yaml"} | Select-Object Name, Length
              try {
                  Get-Item -Path "non-existent-file.txt"
              } catch {
                  Write-Host "Error caught: $($_.Exception.Message)"
              }
              function Get-SystemInfo {
                  param([string]$ComputerName = "localhost")
                  Write-Host "System info for $ComputerName"
                  Write-Host "OS: $($env:OS)"
                  Write-Host "Processor: $($env:PROCESSOR_IDENTIFIER)"
              }
              Get-SystemInfo
              Write-Host "✓ PowerShell advanced commands executed successfully"
          }
          
          # 安全命令测试
          if ('${{ github.event.inputs.test_type }}' -eq 'security') {
              Write-Host "\n=== Security PowerShell Commands ==="
              Get-ExecutionPolicy -List
              Get-Module -ListAvailable | Select-Object Name, Version | Select-Object -First 5
              Get-ChildItem -Path Env: | Where-Object {$_.Name -like "*TOKEN*" -or $_.Name -like "*SECRET*"} | ForEach-Object {
                  Write-Host "Found sensitive environment variable: $($_.Name)"
              }
              Write-Host "✓ PowerShell security commands executed successfully"
          }

      - name: Node.js Terminal Test
        if: github.event.inputs.terminal_type == 'nodejs' || github.event.inputs.terminal_type == 'both'
        shell: cmd
        run: |
          echo === Node.js Terminal Test ===
          echo Terminal Type: ${{ github.event.inputs.terminal_type }}
          echo Test Type: ${{ github.event.inputs.test_type }}
          echo Timestamp: %DATE% %TIME%
          
          :: 设置环境变量
          echo NODE_ENV=development >> %GITHUB_ENV%
          echo NPM_CONFIG_PREFIX=%USERPROFILE%\.npm-global >> %GITHUB_ENV%
          echo PATH=%PATH%;%USERPROFILE%\.npm-global\bin >> %GITHUB_ENV%
          
          :: 安装全局包
          npm install -g npm@latest
          npm install -g yarn
          npm install -g pnpm
          npm install -g typescript
          npm install -g eslint
          npm install -g prettier
          
          :: 基本命令测试
          if "${{ github.event.inputs.test_type }}" == "basic" || "${{ github.event.inputs.test_type }}" == "advanced" (
              echo "\n=== Basic Node.js Commands ==="
              node --version
              npm --version
              yarn --version
              pnpm --version
              npm list -g --depth=0
              
              :: 创建测试项目
              echo {
              echo   "name": "test-project",
              echo   "version": "1.0.0",
              echo   "description": "Test project",
              echo   "main": "index.js",
              echo   "scripts": {
              echo     "test": "echo \"Error: no test specified\" && exit 1"
              echo   },
              echo   "keywords": [],
              echo   "author": "",
              echo   "license": "MIT"
              echo } > package.json
              
              dir
              echo ✓ Node.js basic commands executed successfully
          )
          
          :: 高级命令测试
          if "${{ github.event.inputs.test_type }}" == "advanced" (
              echo "\n=== Advanced Node.js Commands ==="
              
              :: 创建和运行简单应用
              echo console.log('Hello from Node.js!'); > index.js
              node index.js
              
              :: 安装依赖
              npm install express
              
              :: 创建 Express 应用
              echo const express = require('express'); > app.js
              echo const app = express(); >> app.js
              echo const port = 3000; >> app.js
              echo >> app.js
              echo app.get('/', (req, res) => { >> app.js
              echo   res.send('Hello World!'); >> app.js
              echo }); >> app.js
              echo >> app.js
              echo app.listen(port, () => { >> app.js
              echo   console.log(`Example app listening on port ${port}`); >> app.js
              echo }); >> app.js
              
              dir
              type package.json
              echo ✓ Node.js advanced commands executed successfully
          )
          
          :: 安全命令测试
          if "${{ github.event.inputs.test_type }}" == "security" (
              echo "\n=== Security Node.js Commands ==="
              npm audit
              npm config list
              set NODE
              findstr /i "token secret password api_key" package.json || echo No sensitive information found in package.json
              echo ✓ Node.js security commands executed successfully
          )

      - name: Generate Unified Terminal Report
        shell: powershell
        run: |
          Write-Host "=== Unified Terminal Report ==="
          
          $reportContent = @"
          # Unified Terminal Test Report
          
          ## Test Information
          - Terminal Type: ${{ github.event.inputs.terminal_type }}
          - Test Type: ${{ github.event.inputs.test_type }}
          - Timestamp: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          - Runner OS: $env:RUNNER_OS
          - PowerShell Version: $($PSVersionTable.PSVersion.ToString())
          - Node.js Version: $(node --version 2>$null || echo "Not tested")
          - npm Version: $(npm --version 2>$null || echo "Not tested")
          
          ## Test Results
          - ✅ Unified terminal environment set up
          - ✅ Terminal commands executed
          - ✅ Terminal configuration validated
          
          ## System Information
          - Computer Name: $env:COMPUTERNAME
          - User Name: $env:USERNAME
          - Working Directory: $(Get-Location)
          - Environment Variables Count: $(Get-ChildItem -Path Env: | Measure-Object).Count
          "@
          
          $reportPath = ".github/actions-config/logs/unified-terminal-report-$(Get-Date -Format "yyyyMMdd_HHmmss").md"
          $reportDir = Split-Path -Parent $reportPath
          if (!(Test-Path $reportDir)) {
              New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
          }
          
          $reportContent | Out-File -FilePath $reportPath -Force -Encoding UTF8
          
          Write-Host "✓ Unified terminal report generated: $reportPath"

      - name: Upload Unified Terminal Report
        uses: actions/upload-artifact@v4
        with:
          name: unified-terminal-report
          path: .github/actions-config/logs/unified-terminal-report-*.md
