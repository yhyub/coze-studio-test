#!/bin/bash\n\n# GitHub Action 安全扫描脚本\n# 用于检查GitHub Actions的安全状态\n\nset -e\n\n# 配置文件路径 - 支持本地和云端两种模式\n# 本地模式: CONFIG_FILE="actions.yaml"\n# 云端模式: CONFIG_FILE="https://github.com/yhyub/coze-studio-test/blob/main/.github/actions-config/actions.yaml"\nCONFIG_FILE="https://github.com/yhyub/coze-studio-test/blob/main/.github/actions-config/actions.yaml"\n\n# 日志文件路径\nLOG_DIR="logs"\nLOG_FILE="$LOG_DIR/security-scan-$(date +%Y-%m-%d_%H-%M-%S).log"\n\n# 显示帮助信息\nshow_help() {\n    echo "GitHub Action 安全扫描脚本"\n    echo "用于检查GitHub Actions的安全状态"\n    echo ""\n    echo "用法: ./security-scan.sh [选项]"\n    echo ""\n    echo "选项:"\n    echo "  -h, --help          显示帮助信息"\n    echo "  -v, --verbose       显示详细输出"\n    echo "  -a, --action        只扫描指定的Action"\n    echo "  -l, --log           保存扫描结果到日志文件"\n    echo ""\n    echo "示例:"\n    echo "  ./security-scan.sh                # 扫描所有Action"\n    echo "  ./security-scan.sh -a actions/checkout # 只扫描指定Action"\n    echo "  ./security-scan.sh -v -l          # 显示详细输出并保存日志"\n    exit 0\n}\n\n# 解析命令行参数\nparse_args() {\n    while [[ $# -gt 0 ]]; do\n        case $1 in\n            -h|--help)\n                show_help\n                ;;\n            -v|--verbose)\n                VERBOSE=true\n                shift 1\n                ;;\n            -a|--action)\n                TARGET_ACTION=$2\n                shift 2\n                ;;\n            -l|--log)\n                LOG=true\n                shift 1\n                ;;\n            *)\n                echo "错误: 未知参数 '$1'"\n                show_help\n                ;;\n        esac\n    done\n\n    # 设置默认值\n    if [[ -z $VERBOSE ]]; then\n        VERBOSE=false\n    fi\n    if [[ -z $LOG ]]; then\n        LOG=false\n    fi\n    if [[ -z $TARGET_ACTION ]]; then\n        TARGET_ACTION=""\n    fi\n\n    # 创建日志目录\n    if [[ $LOG == true && ! -d $LOG_DIR ]]; then\n        mkdir -p $LOG_DIR\n    fi\n}\n\n# 记录日志\nlog() {\n    local message=$1\n    local level=${2:-info}\n    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")\n    \n    # 输出到控制台\n    if [[ $VERBOSE == true || $level == "error" || $level == "warn" ]]; then\n        case $level in\n            error)\n                echo -e "\033[31m[$timestamp] ERROR: $message\033[0m"\n                ;;\n            warn)\n                echo -e "\033[33m[$timestamp] WARN: $message\033[0m"\n                ;;\n            info)\n                echo -e "\033[32m[$timestamp] INFO: $message\033[0m"\n                ;;\n            debug)\n                if [[ $VERBOSE == true ]]; then\n                    echo -e "\033[34m[$timestamp] DEBUG: $message\033[0m"\n                fi\n                ;;\n        esac\n    fi\n    \n    # 输出到日志文件\n    if [[ $LOG == true ]]; then\n        echo "[$timestamp] $level: $message" >> $LOG_FILE\n    fi\n}\n\n# 检查Action是否使用固定版本\ncheck_fixed_version() {\n    local action_name=$1\n    local version=$2\n    \n    if [[ $version == "master" || $version == "latest" || $version == "HEAD" ]]; then\n        log "Action '$action_name' 使用动态版本 '$version'，建议使用固定版本" warn\n        return 1\n    else\n        log "Action '$action_name' 使用固定版本 '$version'" debug\n        return 0\n    fi\n}\n\n# 检查Action来源是否合法\ncheck_source() {\n    local action_name=$1\n    local source=$2\n    local config_file=$3\n    local raw_config_url=$4\n    \n    # 从配置文件中获取允许的来源\n    if [[ "$config_file" == http* ]]; then\n        # 云端模式: 直接从云端获取允许的来源\n        local allowed_sources=$(curl -s "$raw_config_url" | grep -A 10 "allowed_sources" | grep -v "allowed_sources" | grep -v "^")\n    else\n        # 本地模式: 从本地文件获取允许的来源\n        local allowed_sources=$(grep -A 10 "allowed_sources" $config_file | grep -v "allowed_sources" | grep -v "^")\n    fi\n    \n    if echo "$allowed_sources" | grep -q "$source"; then\n        log "Action '$action_name' 来源 '$source' 合法" debug\n        return 0\n    else\n        log "Action '$action_name' 来源 '$source' 不合法，不在允许列表中" error\n        return 1\n    fi\n}\n\n# 扫描单个Action\nscan_action() {\n    local action_name=$1\n    local version=$2\n    local source=$3\n    local usage=$4\n    local security=$5\n    local workflows=$6\n    local config_file=$7\n    local raw_config_url=$8\n    \n    log "开始扫描Action: $action_name@$version" info\n    \n    local scan_result=0\n    \n    # 检查是否使用固定版本\n    if ! check_fixed_version "$action_name" "$version"; then\n        scan_result=1\n    fi\n    \n    # 检查来源是否合法\n    if ! check_source "$action_name" "$source" "$config_file" "$raw_config_url"; then\n        scan_result=1\n    fi\n    \n    # 检查安全状态\n    if [[ $security == "待审核" ]]; then\n        log "Action '$action_name' 安全状态为 '待审核'，建议尽快审核" warn\n        scan_result=1\n    elif [[ $security == "已审核" ]]; then\n        log "Action '$action_name' 安全状态为 '已审核'" debug\n    else\n        log "Action '$action_name' 安全状态 '$security' 未知" error\n        scan_result=1\n    fi\n    \n    # 检查工作流使用情况\n    if [[ $workflows == "[]" ]]; then\n        log "Action '$action_name' 未在任何工作流中使用" warn\n    else\n        log "Action '$action_name' 在工作流中使用: $workflows" debug\n    fi\n    \n    if [[ $scan_result == 0 ]]; then\n        log "Action '$action_name@$version' 扫描通过" info\n    else\n        log "Action '$action_name@$version' 扫描失败，存在安全问题" error\n    fi\n    \n    return $scan_result\n}\n\n# 从配置文件中读取Actions并扫描\nscan_from_config() {\n    log "从配置文件中读取Actions..." info\n    \n    # 检查配置文件是本地文件还是云端URL\n    if [[ "$CONFIG_FILE" == http* ]]; then\n        # 云端模式: 下载配置文件到临时文件\n        log "使用云端配置文件: $CONFIG_FILE" debug\n        RAW_CONFIG_URL=$(echo "$CONFIG_FILE" | sed 's|github.com|raw.githubusercontent.com|; s|/blob||')\n        TEMP_CONFIG=$(mktemp)\n        if ! curl -s "$RAW_CONFIG_URL" -o "$TEMP_CONFIG"; then\n            log "无法下载配置文件: $RAW_CONFIG_URL" error\n            exit 1\n        fi\n        WORKING_CONFIG="$TEMP_CONFIG"\n    else\n        # 本地模式: 直接使用本地文件\n        log "使用本地配置文件: $CONFIG_FILE" debug\n        if [[ ! -f "$CONFIG_FILE" ]]; then\n            log "配置文件不存在: $CONFIG_FILE" error\n            exit 1\n        fi\n        WORKING_CONFIG="$CONFIG_FILE"\n    fi\n    \n    # 使用yq工具解析YAML文件（如果可用）\n    if command -v yq &> /dev/null; then\n        scan_with_yq "$WORKING_CONFIG"\n    else\n        log "yq工具未安装，使用grep/sed解析YAML文件" warn\n        scan_with_grep_sed "$WORKING_CONFIG"\n    fi\n    \n    # 清理临时文件（如果是云端模式）\n    if [[ "$CONFIG_FILE" == http* ]]; then\n        rm -f "$TEMP_CONFIG"\n    fi\n}\n\n# 使用yq工具扫描Actions\nscan_with_yq() {\n    local temp_config=$1\n    local config_file=$2\n    local raw_config_url=$3\n    local actions_count=$(yq eval '.installed_actions | length' $temp_config)\n    log "找到 $actions_count 个已安装的Actions" info\n    \n    local failed_count=0\n    \n    for ((i=0; i<$actions_count; i++)); do\n        local action_name=$(yq eval ".installed_actions[$i].name" $temp_config)\n        local version=$(yq eval ".installed_actions[$i].version" $temp_config)\n        local source=$(yq eval ".installed_actions[$i].source" $temp_config)\n        local usage=$(yq eval ".installed_actions[$i].usage" $temp_config)\n        local security=$(yq eval ".installed_actions[$i].security" $temp_config)\n        local workflows=$(yq eval ".installed_actions[$i].workflows" $temp_config)\n        \n        # 如果指定了目标Action，只扫描该Action\n        if [[ -n $TARGET_ACTION && $action_name != $TARGET_ACTION ]]; then\n            continue\n        fi\n        \n        if ! scan_action "$action_name" "$version" "$source" "$usage" "$security" "$workflows" "$config_file" "$raw_config_url"; then\n            failed_count=$((failed_count+1))\n        fi\n    done\n    \n    log "扫描完成，共 $actions_count 个Actions，其中 $failed_count 个存在安全问题" info\n    \n    if [[ $failed_count -gt 0 ]]; then\n        return 1\n    else\n        return 0\n    fi\n}\n\n# 使用grep/sed工具扫描Actions\nscan_with_grep_sed() {\n    local temp_config=$1\n    # 读取配置文件中的installed_actions部分\n    local actions_content=$(grep -A 100 "installed_actions:" $temp_config | grep -v "installed_actions:" | grep -B 100 "custom_actions:" | grep -v "custom_actions:")\n    \n    # 将Actions内容分割成单个Action\n    local IFS=$'\n'\n    local action_lines=($actions_content)\n    local current_action=""\n    local action_count=0\n    local failed_count=0\n    \n    for line in "${action_lines[@]}"; do\n        if [[ $line =~ ^\s*-\s*name: ]]; then\n            # 如果已经有当前Action，先扫描它\n            if [[ -n $current_action ]]; then\n                action_count=$((action_count+1))\n                # 解析Action配置\n                local action_name=$(echo "$current_action" | grep "name:" | awk '{print $2}')\n                local version=$(echo "$current_action" | grep "version:" | awk '{print $2}')\n                local source=$(echo "$current_action" | grep "source:" | awk '{print $2}')\n                local usage=$(echo "$current_action" | grep "usage:" | cut -d ' ' -f 2-)\n                local security=$(echo "$current_action" | grep "security:" | awk '{print $2}')\n                local workflows=$(echo "$current_action" | grep "workflows:" | cut -d ' ' -f 2-)\n                \n                # 如果指定了目标Action，只扫描该Action\n                if [[ -z $TARGET_ACTION || $action_name == $TARGET_ACTION ]]; then\n                    if ! scan_action "$action_name" "$version" "$source" "$usage" "$security" "$workflows"; then\n                        failed_count=$((failed_count+1))\n                    fi\n                fi\n            fi\n            # 开始新的Action\n            current_action="$line"\n        elif [[ -n $current_action ]]; then\n            # 添加到当前Action\n            current_action="$current_action\n$line"\n        fi\n    done\n    \n    # 扫描最后一个Action\n    if [[ -n $current_action ]]; then\n        action_count=$((action_count+1))\n        # 解析Action配置\n        local action_name=$(echo "$current_action" | grep "name:" | awk '{print $2}')\n        local version=$(echo "$current_action" | grep "version:" | awk '{print $2}')\n        local source=$(echo "$current_action" | grep "source:" | awk '{print $2}')\n        local usage=$(echo "$current_action" | grep "usage:" | cut -d ' ' -f 2-)\n        local security=$(echo "$current_action" | grep "security:" | awk '{print $2}')\n        local workflows=$(echo "$current_action" | grep "workflows:" | cut -d ' ' -f 2-)\n        \n        # 如果指定了目标Action，只扫描该Action\n        if [[ -z $TARGET_ACTION || $action_name == $TARGET_ACTION ]]; then\n            if ! scan_action "$action_name" "$version" "$source" "$usage" "$security" "$workflows"; then\n                failed_count=$((failed_count+1))\n            fi\n        fi\n    fi\n    \n    log "扫描完成，共 $action_count 个Actions，其中 $failed_count 个存在安全问题" info\n    \n    if [[ $failed_count -gt 0 ]]; then\n        return 1\n    else\n        return 0\n    fi\n}\n\n# 主函数\nmain() {\n    parse_args "$@"\n    log "开始GitHub Action安全扫描" info\n    \n    scan_from_config\n    local scan_result=$?\n    \n    if [[ $scan_result == 0 ]]; then\n        log "所有Action扫描通过，安全状态良好" info\n    else\n        log "部分Action扫描失败，存在安全问题，请查看日志或详细输出" error\n    fi\n    \n    log "GitHub Action安全扫描结束" info\n    \n    exit $scan_result\n}\n\n# 执行主函数\nmain "$@"\n